define(function(require,exports,module){var m=require("domains");var t={};var b={};var h=require("jquery"),k=require("lib"),o=require("juicer"),x=require("wmarea"),g=require("wmverification"),y=require("wmupload"),c=require("wmtips"),s=require("wmlazyload"),l=require("wmbox"),f=new UE.ui.Editor(),w=require("initSpecificationMain"),p,n,v=require("wmcolor");window.document.domain="tcsh.me";var r={sel:function(H,F){var G=h(H);G.empty().append('<option value="0">-请选择-</option>');var E=[],D=F.itemList;for(var C in D){E.push('<option value="'+D[C].value+'">'+D[C].name+"</option>")}G.append(E.join(""))},chk:function(C,H){var F=[],E=H.itemList,G;for(var D in E){G=parseInt(Math.random()*99999)+100;F.push('<li><input type="checkbox" name="chkattr_'+H.id+'" id="labfor_'+G+'" value="'+E[D].value+'" data_txt="'+E[D].name+'"><label class="chk_key" title="'+E[D].name+'" for="labfor_'+G+'">'+E[D].name+"</label></li>")}C.append(F.join(""))},rid:function(C,H){var F=[],E=H.itemList,G;for(var D in E){G=parseInt(Math.random()*99999)+100;F.push('<li><input type="radio" name="ridattr_'+H.id+'" id="labfor_'+G+'" value="'+E[D].value+'" data_txt="'+E[D].name+'"><label class="chk_key" title="'+E[D].name+'" for="labfor_'+G+'">'+E[D].name+"</label></li>")}C.append(F.join(""))}};var z={sel:function(D){var F=[],C,E;C=D.find(".form_sel :selected");E=C.val()-0;if(E){F.push({id:E,value:h.trim(C.html())})}return F},chk:function(D){var C=D.find(":checkbox:eq(0)").attr("name");var E=[];D.find('[name="'+C+'"]:checked').each(function(){var G=h(this),F={};F.id=G.val()-0;F.value=h.trim(G.attr("data_txt"));E.push(F)});return E},rid:function(D){var C=D.find(":radio:eq(0)").attr("name");var E=[];D.find('[name="'+C+'"]:checked').each(function(){var G=h(this),F={};F.id=G.val()-0;F.value=h.trim(G.attr("data_txt"));E.push(F)});return E},txt:function(D){var E=[],C;C=D.find(".form_txt");E.push({id:D.attr("data_id"),value:h.trim(C.val())});return E}};var a={sel:function(E){var F=h('<select class="form_sel"><option value="0">-请选择-</option></select>');var C=h('<li class="form_row" data_type="sel" data_id="'+E.id+'" data_name="'+E.name+'"><label class="row_key">'+((E.required?'<b class="form_must">*</b>':"")+E.name)+"：</label></li>");r.sel(F,E);for(var D in E.otherAttr){F.attr(E.otherAttr[D].value,E.otherAttr[D].name)}return C.append(F)},chk:function(F){var D=h('<li class="form_row" data_type="chk" data_id="'+F.id+'" data_name="'+F.name+'"><label class="row_key">'+((F.required?'<b class="form_must">*</b>':"")+F.name)+'：</label><ul class="floatleft w400"></ul>');var C=D.find("ul");r.chk(C,F);for(var E in F.otherAttr){C.attr(F.otherAttr[E].value,F.otherAttr[E].name)}return D.append(C)},rid:function(F){var D=h('<li class="form_row" data_type="rid" data_id="'+F.id+'" data_name="'+F.name+'"><label class="row_key">'+((F.required?'<b class="form_must">*</b>':"")+F.name)+'：</label><ul class="floatleft w400"></ul>');var C=D.find("ul");r.rid(C,F);for(var E in F.otherAttr){C.attr(F.otherAttr[E].value,F.otherAttr[E].name)}return D.append(C)},txt:function(F){var D=h('<li class="form_row"  data_type="txt" data_id="'+F.id+'" data_name="'+F.name+'"><label class="row_key">'+((F.required?'<b class="form_must">*</b>':"")+F.name)+'：</label><input type="text" class="form_txt w150"></li>');var C=D.find(".form_txt");for(var E in F.otherAttr){C.attr(F.otherAttr[E].value,F.otherAttr[E].name)}return D}};var i=function(C,H){var F=[],E=H.itemList,G;for(var D in E){G=parseInt(Math.random()*99999)+100;F.push(["<li>",'<input type="checkbox" relevance_key="'+G+'" name="chkattr_'+H.id+'" id="labfor_'+G+'" class="setattr" data_id="'+E[D].value+'" data_name="'+E[D].name+'" data_key="'+H.name+'">','<label class="chk_key" title="'+E[D].name+'" input_key="'+G+'" eachdata="'+E[D].name+'" for="labfor_'+G+'" data_id="'+E[D].value+'">'+E[D].name+"</label>",'<input type="text" value="'+E[D].name+'" class="attr_item" key="'+G+'" />',"</li>"].join(""))}E=H.otherAttr;for(D in E){C.attr(E[D].value,E[D].name)}C.append(F.join(""))};var A=function(G,E){var F=parseInt(Math.random()*99999)+100;var D=h('<li class="form_row" wmv="attrEmpty" wmvmsg="属性项必选一项"><label class="row_key">'+((G.required?'<b class="form_must">*</b>':"")+G.name)+'：</label><ul class="floatleft set_attr_box w500" data_name="'+G.name+'" data_id="'+G.id+'"></ul>');var C=D.find("ul");C.attr("sequence",E);i(C,G);C.append('<li><input type="checkbox" name="chkattr_5" id="alllabfor_'+F+'" class="setattrallchk"><label class="chk_key nohide" for="alllabfor_'+F+'">全选</label></li>');return D.append(C)};var d=function(){var D={},C;D.updateId=p.pdt_id;if(D.updateId){D.category_id=p.category_id+"";h(".classparent").val(D.category_id.substr(0,4)+"00").change();h(".classthis").val(D.category_id).change()}};var e=function(){h.ajax({url:m.api+"/category/brand/"+global_setting.brand_id,type:"get",dataType:"jsonp",success:function(G){var E=classList=G;var F=h(".classparent").empty();var D=h(".classthis").empty();D.append('<option value="0">--请选择--</option>');F.append('<option value="0">--请选择--</option>');for(var C in E){F.append('<optgroup value="'+C+'" label="'+E[C].name+'"></optgroup>')}F.find("optgroup").each(function(){var I=h(this),J=I.attr("value");var H=E[J].itemList;for(C in H){I.append('<option value="'+C+'">'+H[C].name+"</option>")}});F.css("zoom","1");d()},error:function(){alert("getSubordinateList  Error !")}})};var q=function(C){if(C-0){h.ajax({url:m.api+"/category/get/"+C,type:"get",dataType:"jsonp",success:function(V){n=V;var G=V.attrList;var F=V.setAttrList;var E=1,Q,I,K,P;var D=h("#comm_attr_list_main"),S=h("#set_attr"),R;D.empty();for(var O in G){for(var N in G[O].otherAttr){Q=p.select[G[O].otherAttr[N].value];G[O].otherAttr[N].value=Q;if(Q==="wmv"){G[O].required=true}}R=a[G[O].type](G[O]);D.append(R)}S.empty();for(O in F){for(N in F[O].otherAttr){Q=p.select[F[O].otherAttr[N].value];F[O].otherAttr[N].value=Q;if(Q==="wmv"){F[O].required=true}}R=A(F[O],O-0+1);S.append(R)}var H=h(".specification_main_box");h(".specification_table").remove();h("[upimg='1']").each(function(){var Y=h(this);var X=h('<table class="s_table specification_table" border="0" cellspacing="0"><thead></thead><tbody></tbody></table>');X.attr("sequence",Y.attr("sequence"));var Z=[],W=X.find("tbody");Y.find("[eachdata]").each(function(){var ad=h(this);var aa=ad.attr("eachdata");var ac=v[aa],ab=ad.attr("for");if(ac){ad.before('<label class="colblock" style="background:'+ac+'" for="'+ab+'"></label>');Z.push(["<tr forkey="+ad.attr("for")+' data_txt="'+ad.attr("eachdata")+'" data_id="'+ad.attr("data_id")+'">','<td style="width:90px"><i class="colblock" style="background: '+ac+'"></i><span input_key="'+ad.attr("input_key")+'">'+aa+"</span></td>",'<td style="width:270px">','<a href="#" class="wm_ico fork1 del_upimg_item" style="visibility: hidden;float:right;"></a><input type="file" class="setattr_file" /><img class="setattr_file_img">',"</td>","</tr>"].join(""))}else{Z.push(["<tr forkey="+ad.attr("for")+' data_txt="'+ad.attr("eachdata")+'" data_id="'+ad.attr("data_id")+'">','<td><span input_key="'+ad.attr("input_key")+'">'+aa+"</span></td>","<td>",'<a href="#" class="wm_ico fork1 del_upimg_item" style="visibility: hidden;float:right;"></a><input type="file" class="setattr_file" /><img class="setattr_file_img">',"</td>","</tr>"].join(""))}});W.append(Z.join(""));H.before(X)});I=p.product_property;if(I){D=h(".comm_attr_list");for(var O in I){K=D.find('[data_id="'+I[O].select_id+'"]');P=K.attr("data_type");switch(P){case"rid":K.find("[value='"+I[O].kv[0].id+"']").attr("checked","checked");break;case"chk":for(var N in I[O].kv){K.find("[value='"+I[O].kv[N].id+"']").attr("checked","checked")}break;case"txt":K.find(".form_txt").val(I[O].kv[0].value);break;case"sel":K.find(".form_sel").val(I[O].kv[0].id);break}}}var L={},J,O,T,Q,M;if(global_setting.SpecificationData&&global_setting.SpecificationData.relation){L.relation=global_setting.SpecificationData.relation;L.dataList=global_setting.SpecificationData.dataList;for(O in L.relation){itemList=L.relation[O].itemList;for(var N in itemList){T=S.find(":checkbox[data_id='"+itemList[N].id+"']");T.attr("checked","checked").change();T.closest("li").find(".attr_item:visible").val(itemList[N].name).change()}}for(O in L.relation){itemList=L.relation[O].itemList;for(var N in itemList){J="";J=itemList[N].src;if(J){var U=h(".specification_table [data_id='"+itemList[N].id+"']");U.find("img").attr("src",J).css("display","block");U.find(".wm_ico").css("visibility","visible")}}}Q=[],M=[];for(O in L.dataList){Q.push(O);M.push(O)}Q=Q.join("!@#");for(O in L.relation){itemList=L.relation[O].itemList;for(var N in itemList){Q=Q.replace(new RegExp("'"+itemList[N].name+"'","g"),"'"+itemList[N].id+"'")}}Q=Q.split("!@#");L.dataList={};for(O in M){L.dataList[Q[O]]=global_setting.SpecificationData.dataList[M[O]]}for(var O in L.dataList){H.find(O).find(".price").val(L.dataList[O].price);H.find(O).find(".quantity").val(L.dataList[O].amount)}h(".quantity:eq(0)").change()}g.position()},error:function(){alert("getCategory  Error !")}})}};var j={"1":function(){var C;C=h('<div class="noshop_box"><p class="msg"><i class="wm_ico sigh2" style="margin: -5px 10px 0 0;"></i>您还没有设置店铺！</p><p class="countdown">5秒后跳转！</p><a href="'+m.sell+'/market" class="go_market">店铺设置</a></div>');l.alert({content:C,btns:[],callback:function(){k.countdown({parent:C,ele:".countdown",countdownModel:'<p class="countdown">${i}秒后跳转！</p>',start:5,endCallBack:function(){window.location.href=m.sell+"/market"}})}});return true},"2":function(){var C;C=h('<div class="initerror_main"><p class="msg"><i class="wm_ico sigh2" style="margin: -5px 10px 0 0;"></i>'+global_setting.flag.txt+"</p></div>");l.alert({content:C,boxCls:"initerror_box",btns:[{cls:"ui_btn_h40red2",res:"close",text:"确定",callback:function(){}},{cls:"ui_btn_h40gray16",res:"close",text:"取消",callback:function(){}}]});return false}};var u=function(){global_setting.no_v_login=1;if(h.browser.msie&&h.browser.version==="6.0"){alert("发布商品页面，不支持IE6及以下版本！");return false}if(h.browser.msie&&h.browser.version==="7.0"){alert("发布商品页面，在IE7内核下有瑕疵，只能满足基本功能，建议升级浏览器！")}if(global_setting.flag&&global_setting.flag.code&&j[global_setting.flag.code]()){return false}var H=global_setting.product_img,F,C;var E=h(".listing_year"),G=h(".listing_month"),J=-2;if(!p){p={}}for(F in global_setting){p[F]=global_setting[F];for(var D in global_setting[F]){if(typeof global_setting[F][D]==="string"||typeof global_setting[F][D]==="number"){global_setting[F][global_setting[F][D]]=D}}}e();f.render("myEditor");f.ready(function(){f.setContent(s.decoding(h("#product_info").html()));f.setHeight(250);setTimeout(function(){h("#myEditor").closest(".form_row").css("zoom","0").next().css("zoom","0")},1000)});x({provincesEle:".selProvince_rent",cityEle:".selCity_rent"});g.addRule([{key:"radioEmpty",fun:function(K){return this.find("[type='radio']:checked").length>0}},{key:"selEmpty",fun:function(){return !!(this.val()-0)}},{key:"up_img",fun:function(K){return this.find("img[src='']").length<5}},{key:"editorEmpty",fun:function(){return f.getContent()}},{key:"bear_type",fun:function(){return h('[name="shipping_type"]:checked').length>0}},{key:"modelEmpty",fun:function(){var K=h('[name="shipping_type"]:checked').val();if(K==2&&h("[name='seller_bear_type']:checked").val()==1){return t.id>0}return true}},{key:"shipping_type",fun:function(){return this.find('[name="seller_bear_type"]:checked').length>0}},{key:"setAttrEmpty",fun:function(){return !!this.find(".setattr:checked").length}},{key:"attrEmpty",fun:function(){return !!this.find(".setattr:checked").length}},{key:"required1",fun:function(){var K,N,M,L;if(!this.find("#seller_bear_type2:checked").length){return true}else{L=/^[0-9]*([1-9]*\.)?\d+$/;K=h.trim(this.find("#freight_mail").val());N=h.trim(this.find("#freight_express").val());M=h.trim(this.find("#freight_ems").val());if((K===""&&N===""&&M==="")){return false}if((L.test(K)||K==="")&&(L.test(N)||N==="")&&(L.test(M)||M==="")){return true}return false}}},{key:"freight_model",fun:function(){if(!this.find("#seller_bear_type1:checked").length){return true}else{return t.id-0}}}]);g.init(function(){this.setDirection("rt")});B();if(H){F=H.length;while(F--){H[F]&&h(".img_item:not(.img_main):eq("+F+")").find("img").attr("src",H[F]).closest(".img_bg").css("display","block")}h(".img_main img").attr("src",h(".img_item:not(.img_main)").find("img[src!='']:eq(0)").attr("src")).closest(".img_bg").css("display","block")}if(global_setting.freight&&global_setting.freight.type){h("#shipping_type2").attr("checked","checked").change();if(global_setting.freight.type===1){h("#seller_bear_type1").attr("checked","checked").change();setShipping(global_setting.freight.id,global_setting.freight.name)}else{h("#seller_bear_type2").attr("checked","checked").change();h("#freight_mail").val(global_setting.freight.mail);h("#freight_express").val(global_setting.freight.express);h("#freight_ems").val(global_setting.freight.ems)}}if(global_setting.location_area){var I=global_setting.location_area+"";h(".selProvince_rent").val(I.substr(0,2)+"0000").change();h(".selCity_rent").val(I)}if(global_setting.shop_window_img){h(".add_recommend_img_hook img").attr("src",global_setting.shop_window_img).css("display","block");h("#recommend1").attr("checked","checked").change()}E.empty().append('<option value="">-请选择-</option>');while(J++<10){E.append('<option value="'+(global_setting.year-J)+'年">'+(global_setting.year-J)+"</option>")}G.empty().append('<option value="">-请选择-</option><option>上半年</option><option>下半年</option><option>1月</option><option>2月</option><option>3月</option><option>4月</option><option>5月</option><option>6月</option><option>7月</option><option>8月</option><option>9月</option><option>10月</option><option>11月</option><option>12月</option>');C=h.trim(h(".ttm").attr("data_ttm"));if(C){C=C.split(" ");E.val(C[0]);G.val(C[1])}h(".add_recommend_img_hook b").empty().append(global_setting.showWindow);b.txt=global_setting.aftermarketMsgTxt||""};var B=function(){var I=h(".comm_up_form"),G=h(".classthis"),D=I.find(".tag_list"),X=I.find(".custom_tag_val"),P,T,E,J,L,C,M=o(['<div class="batch_head">',"<h3>批量设置</h3>","</div>",'<ul class="batch_type wm_form" >',"<li><b>特卖价</b></li>","{@each list as item,index}",'<li><input type="radio" id="${random}_1_${index}"name="batchtype_1" data_name="${item.name}"/><label class="rad_key" for="${random}_1_${index}">相同${item.name}特卖价相同</label></li>',"{@/each}","</ul>",'<ul class="batch_type wm_form" >',"<li><b>数量</b></li>","{@each list as item,index}",'<li><input type="radio" id="${random}_2_${index}" name="batchtype_2" data_name="${item.name}" /><label class="rad_key" for="${random}_2_${index}">相同${item.name}数量相同</label></li>',"{@/each}","</ul>"].join("")),W=[],V=I.find(".stock"),K=I.find(".seller_bear_main"),aa=I.find(".model_data"),Y=I.find(".add_recommend_img_hook"),Z=I.find(".up_recommend_box"),ab="jpg,jpeg,gif,png",ae;SpecificationData={};var S=function(af){if(!T){T=l.alert({boxCls:"successmsg",titleText:"上架成功",content:'<p style="width: 500px;text-align: center;font-size: 14px; padding: 50px;line-height: 30px; font-family: simsun;"><b style="color:#e13436;font-weight: 500;">恭喜，您的商品已经成功上架！</b>您可以继续上架商品，或者进行其他操作在您发布10款商品后，同城生活将建立您的专属卖场</p>',btns:[{cls:"ui_btn_h46red8 mrl",text:"继续上架",res:"close",callback:function(){window.location.href=m.item+"/product"}}],callback:function(){this.close=function(){window.location.href=window.location.href}}})}T.show()};var Q=function(af){if(!E){E=l.alert({boxCls:"successmsg",titleText:"修改成功",content:'<p style="width:350px;text-align: center;font-size: 14px; padding: 50px;line-height: 30px; font-family: simsun;font-weight: 700;color: #535353;"><b style="color:#e13436;font-weight: 700;"><i class="wm_ico hook8" style="margin-right:10px;margin-top: -8px;"></i>恭喜您！</b>您的修改已经成功。</p>',btns:[{cls:"ui_btn_h46red8 mrl",text:"确定",res:"close",callback:function(){if(window.opener){window.opener.location.href=window.opener.location.href}window.location.href=m.item+"/"+af+".html"}}],callback:function(){this.close=function(){window.location.href=window.location.href}}})}E.show()};var U=function(){var af;if(!W.length){af=h("#set_attr").find(".set_attr_box");af.each(function(){var ag=h(this);W.push({name:ag.attr("data_name")})})}};var R=function(af){var ag=h(this);$parent=ag.closest(af);$parent.find(".form_file").click()};var O=function(){var ah=h(this).closest(".set_attr_box");var ag=h(".specification_table[sequence='"+ah.attr("sequence")+"']"),ai=ag.find("tbody");var ah=h(this).closest("ul");if(ah.attr("upimg")-0){var af=ah.find(".setattr:checked");if(af.length){ag.css("display","block");ai.find("tr").css("display","none");af.each(function(){ai.find('[forkey="'+h(this).attr("id")+'"]').css("display","block")})}else{ag.css("display","none")}g.position()}return false};var N=function(){var ar=h(".specification_main"),ag=ar.find("tbody"),ak=ar.find("thead");var aj=h("#set_attr").find("[sequence]"),ai,ah,af,an;var ap=true,aq,ao=h("#set_attr"),am={},au;var al=h(".specification_main_box");SpecificationData.relation=[];h("#set_attr").find(".set_attr_box").each(function(){var aw=h(this);var av={key:aw.attr("data_name"),id:aw.attr("data_id"),itemList:[]};aw.find(".setattr:checked").each(function(){var ax=h(this);av.itemList.push({id:ax.attr("data_id"),name:ax.closest("li").find(".attr_item").val(),key:'input_key="'+ax.attr("relevance_key")+'"'})});SpecificationData.relation[aw.attr("sequence")]=av});var at=function(){var aw=[],av;for(var ax in n.setAttrList){av={};av.name=n.setAttrList[ax].name;aw.push(av)}aw.push({name:"特卖价",sign:"*"});aw.push({name:"数量",sign:"*"});aw.push({name:"批量操作"});w.initSpecificationMainThead({setData:aw,thead:ak})};ag.empty();aj.each(function(){var av=h(this);ap=ap&&!!av.find(":checked").length});if(!ap){al.removeClass("h600scroll").css("display","none");return}at();w.initSpecificationMain({setData:SpecificationData,tbody:ag});ar.css("display","block");if(al.outerHeight()>=600){al.addClass("h600scroll").css("display","block")}else{al.css("display","block")}return};var F=function(){var af=parseInt(Math.random()*999)+100;U();return M.render({list:W,random:af})};var ad=function(ag){var af=h(".specification_main");if(ag){SpecificationData.dataList={}}U();var ah;af.find(".specification_dataitem").each(function(){var aj=h(this);ah=[];for(var ai in W){ah.push("[data_"+W[ai].name+"='"+aj.attr("data_"+W[ai].name)+"']")}SpecificationData.dataList[ah.join("")]={price:aj.find(".price").val(),quantity:aj.find(".quantity").val()}})};var ac=function(an){var ak,aj=999,al=-1,ai,am,ao,af,ah;ak=I.find("#set_attr");if(g.verify()){ak.find(".set_attr_box").each(function(){var ap=h(this);var aq=ap.attr("sequence")-0;aj=Math.min(aj,aq);al=Math.max(al,aq)});ai=function(au,ap,ar){var aq=ap;var at=ak.find('.set_attr_box[sequence="'+au+'"]');try{at.find(".setattr:checked").each(function(){var aA=h(this);var az={};var ax=ar||"";var ay=at.attr("data_name"),aw=aA.attr("data_id");ax+="[data_"+ay+'="'+aw+'"]';az.kv={};az.kv[ay]=aA.closest("li").find(".attr_item").val();az.kv.id=aw;az.itemList=[];ai(au+1,az.itemList,ax);if(au===al){az.itemList=[{kv:{price:h(ax).find(".price").val()-0,amount:h(ax).find(".quantity").val()-0},itemList:[]}]}aq.push(az)})}catch(av){if(!confirm("发现异常数据，是否继续提交？提交后可修改")){throw"数据异常，提交被终止！"}}};ah=function(){var ap=I.find("#comm_attr_list_main");ag.product_property=[];ap.find(".form_row").each(function(){var ar=h(this),aq={},at;at=z[ar.attr("data_type")](ar);if(at.length){aq.select_id=ar.attr("data_id");aq.select_name=ar.attr("data_name");aq.kv=at;ag.product_property.push(aq)}});ag.product_property=JSON.stringify(ag.product_property)};var ag={};if(global_setting.pdt_id){ag.product_id=global_setting.pdt_id}ag.category_id=I.find(".classthis").val();ag.product_name=h.trim(I.find(".comm_name").val());ag.market_price=I.find(".price").val();ag.sale_price=I.find(".sale_price").val();ag.goods_id=h.trim(I.find(".goods_id").val());ag.product_img=[];I.find(".img_item:not(.img_main)").each(function(){var ap=h(this).find("img").attr("src");ag.product_img.push(ap)});ag.product_img=JSON.stringify(ag.product_img);ag.compare_price=[];ag.bread=encodeURIComponent(I.find(".bread").val());I.find(".compare_item").each(function(){var at=h(this);var ap=at.find("select").val()-0,ar=at.find(".compare_price").val()-0,aq=at.find(".compareurl").val();if(ap&&ar&&aq){ag.compare_price.push({name:ap,price:ar,url:aq})}});ag.compare_price=JSON.stringify(ag.compare_price);ag.info=s.coding(f.getContent());ag.stock_count_type=I.find('[name="inventory_count"]:checked').val();ag.location_area=I.find(".selCity_rent").val();ag.invoice=I.find("[name='invoice']:checked").val();ag.shop_window_img={};if(I.find("#recommend1:checked").length){if(I.find(".add_recommend_img_hook img").attr("src")){ag.shop_window_img.type=1;ag.shop_window_img.img=I.find(".add_recommend_img_hook img").attr("src")}else{ag.shop_window_img.type=0}}else{if(global_setting.shop_window_img){ag.shop_window_img.type=-1}else{ag.shop_window_img.type=0}}ag.shop_window_img=JSON.stringify(ag.shop_window_img);ag.freight={};$shippingType=I.find("#shipping_type1:checked");am=$shippingType.val();if(!am){$shippingType=I.find("[name='seller_bear_type']:checked");am=$shippingType.val();if($shippingType.closest("li").find(".model_data").length){ag.freight.id=t.id;ag.freight.name=t.name}else{ag.freight.mail=I.find("#freight_mail").val();ag.freight.express=I.find("#freight_express").val();ag.freight.ems=I.find("#freight_ems").val()}}ag.freight.type=am;ag.after_sale=b.txt||"";ag.freight=JSON.stringify(ag.freight);ag.product_norm=[];ai(aj,ag.product_norm);ag.product_norm=JSON.stringify(ag.product_norm);ag.ttm=I.find(".listing_year").val()+" "+I.find(".listing_month").val();ag.tag_list=[];D.find(".tag_item").each(function(){ag.tag_list.push(encodeURIComponent(h(this).attr("data_name")))});ag.tag_list=JSON.stringify(ag.tag_list);ah();h.ajax({url:m.item+"/api/product/add",type:"post",data:ag,dataType:"json",success:function(ar){typeof an==="function"&&an();var at={},aq;ag.product_norm=JSON.parse(ag.product_norm);if(ar.success){aq=ar.id;ao=I.find(".specification_table");var ap=['<div class="loading_con">','<i class="loadingbg loading18_18_1"></i><span class="loading_msg">商品上架成功，正在处理图片......</span>','<ul class="loading_list">',"</ul>","</div>"].join("");ap=h(ap);var au=ap.find("ul");ao.find("tr:visible").each(function(){var aw=h(this),av=aw.find(":file");if(av.val()){au.append('<li class="loading_item" data="'+aw.closest(".specification_table").attr("sequence")+'">'+h(this).find("td:eq(0)").html()+'<div class="schedule_p"><p class="schedule_s"></p></div></li>')}});L=l.invBox({boxCls:"loadingBox",content:ap,btns:[]});L.show();ao.find("tr:visible :file").each(function(){var av=h(this);if(av.val()){av.attr("isup","t")}});af=ao.find("tr:visible :file");L.wmBox.find(".loading_item:eq(0) .schedule_s").animate({width:"30%"},1000);y.queueUpLoad(af,function(){ap.find(".loading_msg").empty().append("图片上传完毕！正在整合");var aw=[];for(var av in at){if(!at[av].length){delete at[av]}}h.ajax({url:m.item+"/api/product/AddColor",type:"post",data:{id:aq,files:JSON.stringify(at)},dataType:"json",success:function(ax){if(ax&&ax.success){setTimeout(function(){L.close();if(global_setting.pdt_id){Q(aq)}else{S(aq)}},2000)}else{}}})},function(aA){var az=this.closest("tr");var aw=this.closest(".specification_table");var ay=h(".set_attr_box[sequence='"+aw.attr("sequence")+"']");var av=ay.attr("data_name");at[av]=at[av]||[];var ax=L.wmBox.find("[animate]").length;L.wmBox.find(".loading_item:eq("+(ax)+") .schedule_s").attr("animate","t").stop().animate({width:"100%"},2000);var aB=aA.response.imgurl||az.find("img").attr("src");if(aB){at[av].push({kv:az.attr("data_txt"),url:aB,id:az.attr("data_id")})}})}else{if(!C){C=l.alert({boxCls:"err_box_msg",titleText:"上架失败",content:'<p style="width: 320px;text-align: center;font-size: 14px; padding: 40px 40px 15px 40px;line-height: 30px; font-family: simsun;">上架失败，请稍候再试！</p>',btns:[{cls:"ui_btn_h46red8 mrl",text:"确定",res:"close",callback:function(){}}],callback:function(){this.close=this.hide}})}C.show()}},error:function(){typeof an==="function"&&an();if(!J){J=l.alert({boxCls:"err_box_msg",titleText:"上架失败",content:'<p style="width: 320px;text-align: center;font-size: 14px; padding: 40px 40px 15px 40px;line-height: 30px; font-family: simsun;">上架失败，请稍候再试！</p>',btns:[{cls:"ui_btn_h46red8 mrl",text:"确定",res:"hide",callback:function(){}}],callback:function(){this.close=this.hide}})}J.show()}})}else{typeof an==="function"&&an()}};var H=function(ag){var af,ah=I.find(":submit");if(!ae){af=h('<div class="nologin_box"><p class="msg"><i class="wm_ico sigh2" style="margin: -5px 10px 0 0;"></i>'+(ag||"操作时间过长，请在<b>新页面重新登录</b>后再提交！")+'</p><a href="'+m.account+'/Login?loginend=t" target="_blank" class="go_login">新页面登录</a></div>');ae=l.alert({content:af,btns:[],callback:function(){var ai=this;this.close=this.hide;this.wmBox.on("click",".go_login",function(){ai.hide()})}})}if(ag){ae.setCon('<div class="nologin_box"><p class="msg"><i class="wm_ico sigh2" style="margin: -5px 10px 0 0;"></i>'+(ag||"操作时间过长，请在<b>新页面重新登录</b>后再提交！")+'</p><a href="'+m.account+'/Login?loginend=t" target="_blank" class="go_login">新页面登录</a></div>')}ae.show();ah.closest(".ui_btn").removeClass("ui_btn_h40gray16");ah.val("提交")};I.on("change.classType",".classparent",function(){var aj=h(this),ak=aj.val();var ai=classList;var ag=ak.substr(0,2);var af=ai[ag+"0000"].itemList[ak].itemList;G.empty().append('<option value="0">--请选择--</option>');for(var ah in af){G.append('<option value="'+ah+'">'+af[ah].name+"</option>")}return false});I.on("change.initAttr",".classthis",function(){q(h(this).val());return false});I.on("click",".up_img_btn_hook",function(){R.call(this,".img_item");return false});I.on("click",".add_recommend_img_hook",function(){R.call(this,".up_recommend_box");return false});h(".up_recommend_box .form_file").change(function(){var af=h(this);y.upload(af,function(ag){if(ag.response){this.closest(".up_recommend_box").find(".add_recommend_img_hook img").attr("src",ag.response.imgurl).css("display","block")}});return false});h(".img_item .form_file").change(function(){var ah=h(this);var af;var ag=ah.val();ag=ag.substr(ag.lastIndexOf(".")+1).toLowerCase();if(ab.indexOf(ag)>=0){y.upload(ah,function(aj){var ai=this.closest(".img_item");if(aj.response){ai.find(".up_img_btn_hook img").attr("src",aj.response.imgurl);if(ai.hasClass("img_main")){h(".up_img_list .img_item:eq(1) img").attr("src",aj.response.imgurl)}if(ai.index()==1){h(".up_img_list .img_main img").attr("src",aj.response.imgurl);h(".up_img_list .img_main .img_bg").css({display:"block"})}ai.find(".img_bg").css({display:"block"})}})}else{af=ah.data("errtips");if(!af){af=new c({ele:ah.closest(".img_item"),con:"<p>请选择："+ab+"格式的文件进行上传！</p>",close:2000,direction:"rc",offset:{top:-5}});ah.data("errtips",af)}af.show()}return false});I.on("change.shipping","[name='shipping_type']",function(){var af=h(this);if(af.closest(".shipping_type_item").find(".seller_bear_main").length){K.css("display","block")}else{K.css("display","none")}});I.on("change.seller_bear","[name='seller_bear_type']",function(){var af=h(this);if(af.closest("li").find(".model_data").length){aa.css("display","inline")}else{aa.css("display","none")}});I.on("change.recommend","#recommend1",function(){var af=h(this);if(af.attr("checked")){Z.addClass("show_add").closest(".form_row").next().css("zoom","0").css("zoom","1")}else{Z.removeClass("show_add").closest(".form_row").next().css("zoom","0").css("zoom","1")}});I.on("change.setAttr",".setattr",function(){var ah=h(this),ai=ah.closest("li"),af=ai.closest("ul"),ag=af.data("errTips");ag&&ag.hide();if(ah.attr("checked")){ai.find(".attr_item").css("display","inline-block");ai.find(".chk_key").css("display","none")}else{ai.find(".attr_item").css("display","none");ai.find(".chk_key").css("display","inline-block")}O.call(this);N();g.position()});I.on("change.setattrall",".setattrallchk",function(){var ag=h(this),af=ag.closest("ul");if(ag.attr("checked")){af.find(".setattr").attr("checked","checked");af.find(".attr_item").css("display","inline-block");af.find(".chk_key:not(.nohide)").css("display","none")}else{af.find(".setattr").removeAttr("checked");af.find(".attr_item").css("display","none");af.find(".chk_key:not(.nohide)").css("display","inline-block")}O.call(this);N();return false});h("body").on("click.hideBatch_box",function(){h(".batch_box").css("display","none")});I.on("click.batchSet",".batch_set",function(){var ag=h(this);h(".batch_box").css("display","none");var af=ag.data("box");if(!af){af=l.relyBox({rely:ag,boxCls:"batch_box",content:F(),btns:[{cls:"ui_btn_h22red10",res:"hide",text:"确定",callback:function(){var al=ag.closest("tr");var aj=this.wmBox.find("[name='batchtype_1']:checked");var ak=this.wmBox.find("[name='batchtype_2']:checked");var ai=aj.attr("data_name");var ao=ak.attr("data_name");var ah=h(".specification_main_box");var an=al.find(".price").val();var am=al.find(".quantity").val();ah.find("tr[data_"+ai+"='"+al.attr("data_"+ai)+"']").each(function(){h(this).find(".price").val(an)});ah.find("tr[data_"+ao+"='"+al.attr("data_"+ao)+"']").each(function(){h(this).find(".quantity").val(am)});ad();this.hide();ah.find(".quantity:eq(0)").change();return false}},{cls:"ui_btn_h22gray6",res:"hide",text:"取消",callback:function(){this.hide()}}]});ag.data("box",af)}af.show();return false});I.on("blur.cacheData",".cache_data_hook",function(){var ai=h(this),ah=ai.closest("tr"),aj=[],ag;U();for(var af in W){aj.push("[data_"+W[af].name+"='"+ah.attr("data_"+W[af].name)+"']")}ag="tr"+aj.join("");if(!SpecificationData.dataList){SpecificationData.dataList={}}SpecificationData.dataList[ag]=SpecificationData.dataList[ag]||{};if(ai.hasClass("price")){SpecificationData.dataList[ag].price=ai.val()}if(ai.hasClass("quantity")){SpecificationData.dataList[ag].quantity=ai.val()}});I.on("change.linkage",".attr_item",function(){var al=h(this),aj=al.attr("key"),ag=al.closest(".set_attr_box"),ai=h.trim(al.val()),ak,af,ah;if(!aj){return}ak=h("[input_key='"+aj+"']");af=ak.html();ak.html(ai);ak.closest("[data_txt]").attr("data_txt",ai);aj=ag.attr("data_name");ah=ak.closest(".specification_dataitem");ad(true)});I.on("change.stockcon",".specification_main .quantity",function(){var af=h(".specification_main").find(".quantity");var ag=0;af.each(function(){ag+=(h(this).val()-0)||0});V.val(ag)});I.on("click.gotoShipping",".choose_shipping_model",function(){window.open(m.item+"/logisticstemplate?isparentopen=t");return false});I.on("click",".choose_aftermarket_msg",function(){window.open(m.item+"/aftersale");return false});I.on("click.submit",":submit",function(){var ag=h(this),af=ag.closest(".ui_btn");if(global_setting.flag&&global_setting.flag.code-0){j[global_setting.flag.code]();return false}if(af.hasClass("ui_btn_h40gray16")){return false}af.addClass("ui_btn_h40gray16");ag.val("验证数据中...");k.verificationLogin(function(){var ah=k.getRole(1);if(ah.key==2){ac(function(){af.removeClass("ui_btn_h40gray16");ag.val("提交")})}else{H("登录账号为买家账号，<b>请重新登录</b>！")}},H);return false});window.setShipping=function(ag,af){t.id=ag;t.name=af;I.find(".model_data span:eq(0)").empty().append(af);I.find(".choose_shipping_model .ui_btn_txt").empty().append("重新选择");g.verify(I.find(".shipping_type"))};window.setAftermarketMsg=function(ag,af){b.id=ag;b.txt=af;I.find(".aftermarket_remark p").empty().append(af);I.find(".choose_aftermarket_msg .ui_btn_txt").empty().append("重新选择")};I.on("click.delUpimgItem",".del_upimg_item",function(){var af=h(this);af.closest("td").find("img").attr("src","").css("display","none");af.css("visibility","hidden");return false});I.on("change",".setattr_file",function(){var af=h(this).closest("td");af.find("img").attr("src","").css("display","none");af.find(".del_upimg_item").css("visibility","hidden")});I.find(".comm_name").on("keyup",function(){var af=h(this),ag;if(P&&P.length){ag=h.trim(af.val()).length;P.empty().append(ag+"/40");if(ag>40){P.css({color:"#e13436"})}else{P.css({color:"#f47d15"})}}else{P=af.closest(".form_row").find(".form_remark b");af.keyup()}});I.find(".comm_name").keyup();I.on("click",".create_tag",function(){var af=[],ah,ag={};var aj=I.find("#comm_attr_list_main");var ai=h.trim(I.find(".comm_name").val()).split(" ");for(ah in ai){if(ai[ah].length&&ai[ah].length>=2&&ai[ah].length<=8&&!D.find(".tag_item[data_name='"+ai[ah]+"']").length&&!ag[ai[ah]]){af.push('<li class="tag_item" data_name="'+ai[ah]+'">'+ai[ah]+'<a class="wm_ico fork2  remove_tag" href="#"></a></li>');ag[ai[ah]]=1}}aj.find(".form_row").each(function(){var al=h(this),ak={},am;am=z[al.attr("data_type")](al);for(ah in am){if(am[ah].value&&am[ah].value.length>=2&&am[ah].value.length<=8&&!D.find(".tag_item[data_name='"+am[ah].value+"']").length&&!ag[am[ah].value]){af.push('<li class="tag_item" data_name="'+am[ah].value+'">'+am[ah].value+'<a class="wm_ico fork2  remove_tag" href="#"></a></li>');ag[am[ah].value]=1}}});D.find(".tag_item:not(.no_remove)").remove();D.prepend(af.join(""));return false});I.on("click",".remove_tag",function(){h(this).closest(".tag_item").fadeOut(function(){h(this).remove()});return false});I.on("click",".add_custom_tag",function(){var af=h.trim(X.val());if(af&&af.length>=2&&af.length<=8&&!D.find(".tag_item.no_remove[data_name='"+af+"']").length){D.prepend('<li class="tag_item no_remove" data_name="'+af+'">'+af+'<a class="wm_ico fork2  remove_tag" href="#"></a></li>');X.val("")}else{k.BGShine({ele:X,original_color:"#fff",change_color:"#ff6363",frequency:3})}return false})};u()});