define(function(require,exports,module){var h=require("domains");var e=require("jquery"),i=require("juicer"),m=require("wmupload"),f=require("lib"),a=require("wmtips"),g=require("wmbox"),d=require("verification");require("core-css");require("theme-css");require("datepicker-css");require("jquery.ui.core")(e);require("jquery.ui.widget")(e);require("jquery.ui.datepicker")(e);require("datepicker-zh-CN")(e);var c={},n={},k;var j=i(['<div class="up_ad_material_main wm_form">','<a href="#" class="close_ico close_80_80_1 close_btn"></a>','<div class="up_ad_material_title"><h3>添加广告素材</h3><span class="remark">推荐使用按照尺寸要求制作图片，并采用本地上传</span></div>',"<ul>",'<li class="form_row not_wrap">','<label class="row_key">尺寸：</label><span class="adwh">${adWH}</span></li>','<li class="form_row not_wrap">','<label class="row_key">支持格式：</label><span>JPEG，GIF，PNG</span></li>','<li class="form_row">','<label class="row_key">广告链接地址：</label><input type="text" class="form_txt ad_url" /></li>','<li class="form_row">','<label class="row_key">选择广告图片：</label>','<div class="floatleft w370">','<ul class="img_list">',"</ul>",'<span class="ui_btn ui_btn_h27gray8 up_new_img"><span class="ui_btn_txt">本地上传</span><input type="file" class="form_file add_new_img"></span>',"</div>","</li>",'<li class="form_row">','<label class="row_key">广告标题：</label><div class="floatleft"><input type="text" class="form_txt ad_msg" /><span class="remark">简洁明了的概括产品，字数不得超过15个字</span></div></li>','<li class="form_row"><label class="row_key">&nbsp;</label><a href="#" class="ui_btn ui_btn_h39red15 save"><span class="ui_btn_txt">确定</span></a></li>',"</ul>","</div>"].join(""));var b=function(r,s){var q=e(".cycle");var p=[];do{p.push('<option value="'+s+'">'+s+"天</option>")}while(s-->r);q.removeAttr("disabled").empty().append(p.join(""))};var l=function(){document.domain="tcsh.me";d.addRule([{key:"materialEmpty",fun:function(){var r=e(".ad_check_in_form"),s=r.find(".ad_url"),q=r.find(".ad_msg");if(!(s.length&&e.trim(s.val()).length&&q.length&&e.trim(q.val()).length)){setTimeout(function(){d.hideTips()},2000);return false}return true}},{key:"imgEmpty",fun:function(){var q=e(".ad_check_in_form"),r=q.find(".ad_img");return !!r.length&&!!r.attr("src")}},{key:"imgType",fun:function(){var q=e(".ad_check_in_form"),r=q.find(".ad_img"),t=r.attr("src"),s="jpeg,jpg,gif,png";return !!r.length&&!!r.attr("src")&&s.indexOf(f.getSuffixName(t).toLowerCase())>-1}}]);var p=e(".ad_check_in_form");d.init(p,function(){this.setTipSkin("yellow1")});o();if(global_setting.initData){c.pageURL=global_setting.initData.page_url;p.find(".page_list option[page_url='"+global_setting.initData.page_url+"']").attr("selected","selected").change();window.dw(global_setting.initData.locateKey,true);p.find(".cycle").val(global_setting.initData.cycle)}};var o=function(){var u=e("body"),z=e(".ad_check_in_form"),x=z.find(".date_list"),y,q,v=z.find(".before_box"),p,t=z.find(".ad_img"),w=z.find(".submit_material"),s=new Date(global_setting.serverDate-0).getTime();var r=function(B,A){if(B){return'<li class="chk_img '+(A?"url_relevance_img":"")+'"><a href="#"><img src="'+B+'"/></a><span class="wm_ico hook13 nail"></span></li>'}return""};z.on("click",".go_precision",function(){var E=e(this),A=z.find(".page_list"),D=A.find(":selected");var B=D.attr("page_url"),C=global_setting.urlList[B];c.pageURL=B;f.cookie("wmad_locateKeyList",C.locateKeyList.join(","));f.cookie("wmad_asRemarkImgList",C.asRemarkImgList.join(","));u.css({overflow:"hidden"});k=g.invBox({boxId:"wmad_locate",content:'<a href="#" class="close_ico close_80_80_1 close" style="top: 15px;right: 25px;position: absolute;"></a>',callback:function(){this.setCon('<a href="#" class="close_ico close_80_80_1 close" style="top: 15px;right: 25px;position: absolute;"></a><iframe src="'+B+'" style="width:100%;height:'+this.wmBox.outerHeight()+'px"></iframe>')}});k.show(function(){this.wmBox.css({"margin-top":0,"margin-left":0,margin:0,left:0,top:0,bottom:0,right:0})});return false});z.on("click",".submit_material,.submit_material2",function(){var B=e(this),A=B.data("v_tip");if(c.locateKey){if(!p){p=g.invBox({boxId:"up_ad_material",content:j.render({adWH:n.adWH}),callback:function(){var C=this;this.close=this.hide;var D="jpeg,jpg,gif,png";this.wmBox.find(".ad_url").on("change",function(){var E=e(this);e.ajax({url:h.api2+"/product/getimg.json",data:{num:-1,url:encodeURIComponent(E.val())},type:"get",dataType:"jsonp",success:function(I){var F,H;if(I&&I.length){F=[];C.wmBox.find(".url_relevance_img").remove();for(var G in I){F.push(r(I[G],1))}C.wmBox.find(".img_list").append(F.join(""))}if(global_setting.initData){H=C.wmBox.find(".chk_img img[src='"+global_setting.initData.curr_img+"']");if(H.length){H.closest(".chk_img").click()}else{H=e(r(global_setting.initData.curr_img));C.wmBox.find(".img_list").prepend(H);H.click()}}}})});this.wmBox.find(".add_new_img").on("change",function(){if(D.indexOf(f.getSuffixName(e(this).val()).toLowerCase())>-1){m.upload(e(this),function(E){C.wmBox.find(".img_list").prepend(r(E.response.imgurl))})}else{alert("请上传jpg，gif，png文件！")}});this.wmBox.on("click",".chk_img",function(){C.wmBox.find(".chked").removeClass("chked");e(this).addClass("chked");return false});this.wmBox.on("click",".save",function(){if(!(y&&y.length)){v.before('<li class="form_row"><label class="row_key"><b class="form_must">*</b>广告链接地址：</label><input type="text" class="form_txt w440 ad_url" wmv="empty|url" wmvmsg="广告链接地址不能为空！|请输入正确的URL地址！"/></li><li class="form_row"><label class="row_key"><b class="form_must">*</b>广告标题：</label><input type="text" class="form_txt w440 ad_msg"wmv="empty|max:15" wmvmsg="广告标题不能为空！|广告标题不能超过15个字符！" /></li>');y=z.find(".ad_url");q=z.find(".ad_msg")}y.val(C.wmBox.find(".ad_url").val());q.val(C.wmBox.find(".ad_msg").val());t.attr("src",C.wmBox.find(".chked img").attr("src")).css({display:"block"});w.replaceWith('<a href="#" class="ui_btn ui_btn_h27gray8 submit_material2"><span class="ui_btn_txt">重新选择素材</span></a>');C.hide();return false});this.wmBox.on("click",".close_btn",function(){C.hide();return false});if(global_setting.initData){y=z.find(".ad_url");q=z.find(".ad_msg");this.wmBox.find(".ad_url").val(global_setting.initData.ad_url).change();this.wmBox.find(".ad_msg").val(global_setting.initData.ad_msg)}}})}d.hideTips(z);y&&p.wmBox.find(".ad_url").val(y.val());q&&p.wmBox.find(".ad_msg").val(q.val());p.wmBox.find(".adwh").empty().append(n.adWH);p.show()}else{if(!A){A=new a({ele:B,con:'<p><span class="iconfont">&#xf0142;</span>请先确定广告位置！</p>',close:3000,direction:"rt",offset:{left:10,top:5}});B.data("v_tip",A)}A.show()}return false});z.on("click",":submit",function(){var B=e(this),A;var C=h.api2+"/tempadvert/seller/add.json";if(d.verify(z)){c.ad_name=encodeURIComponent(z.find(".ad_name").val());c.ad_sdate=z.find(".show_date").val();c.cycle=z.find(".cycle").val();c.ad_img=encodeURIComponent(t.attr("src")||"");c.channelId=z.find(".page_list").val();if(global_setting.initData&&global_setting.initData.guid){c.stateStr=global_setting.initData.stateStr;c.guid=global_setting.initData.guid;C=h.api2+"/advert/seller/update.json";y=z.find(".ad_url");q=z.find(".ad_msg")}c.ad_url=encodeURIComponent(y.val());c.ad_msg=encodeURIComponent(q.val());A=B.data("verificationBox");if(!A){A=g.invBox({boxId:"verification_box",content:'<p class="msg"><i class="wm_ico loading32_32_1" style="margin-right: 14px;"></i>正在检测数据…</p>'});B.data("verificationBox",A)}A.setCon('<p class="msg"><i class="wm_ico loading32_32_1" style="margin-right: 14px;"></i>正在检测数据…</p>');A.position();A.show();e.ajax({url:h.api2+"/advert/checkurl.json",type:"get",dataType:"jsonp",cache:false,data:{ad_url:c.ad_url},success:function(D){if(D.success){A.setCon('<p class="msg"><i class="wm_ico loading32_32_1" style="margin-right: 14px;"></i>验证成功，保存中...</p>');A.position();e.ajax({url:C,data:c,dataType:"jsonp",type:"get",success:function(E){if(E.success){A.setCon('<p class="msg"><i class="wm_ico hook8" style="margin-right: 14px;"></i>提交成功，等待审核！<span class="remark">0秒后关闭</span></p>');A.position();f.countdown({parent:A.wmBox.find(".msg"),ele:"#verification_box .remark",countdownModel:'<span class="remark">${i}秒后跳转，单击马上跳转</span>',start:3,endCallBack:function(){window.location.reload()}})}else{A.setCon('<p class="msg"><i class="wm_ico hook8" style="margin-right: 14px;"></i>'+(E.error||"提交失败！")+'<span class="remark">0秒后关闭</span></p>');A.position();f.countdown({parent:A.wmBox.find(".msg"),ele:"#verification_box .remark",countdownModel:'<span class="remark">${i}秒后关闭</span>',start:3,endCallBack:function(){A.hide()}})}},error:function(){A.setCon('<p class="msg"><i class="wm_ico ban1" style="margin-right: 14px;"></i>服务器繁忙，请稍候再试！<span class="remark">0秒后关闭</span></p>');A.position();f.countdown({parent:A.wmBox.find(".msg"),ele:"#verification_box .remark",countdownModel:'<span class="remark">${i}秒后关闭</span>',start:3,endCallBack:function(){A.hide()}})}})}else{A.setCon('<p class="msg"><i class="wm_ico ban1" style="margin-right: 14px;"></i>不允许输入同城生活以外的URL，或者非商家本人的商品和店铺！<span class="remark">0秒后关闭</span></p>');A.position();f.countdown({parent:A.wmBox.find(".msg"),ele:"#verification_box .remark",countdownModel:'<span class="remark">${i}秒后关闭</span>',start:3,endCallBack:function(){A.hide()}})}},error:function(){A.setCon('<p class="msg"><i class="wm_ico ban1" style="margin-right: 14px;"></i>服务器繁忙，请稍候再试！<span class="remark">0秒后关闭</span></p>');A.position();f.countdown({parent:A.wmBox.find(".msg"),ele:"#verification_box .remark",countdownModel:'<span class="remark">${i}秒后关闭</span>',start:3,endCallBack:function(){A.hide()}})}})}return false});z.find(".page_list").on("change",function(){var B=e(this),A=B.find("option:selected").attr("page_url");c.locateKey=null;z.find(".precision_name").empty();z.find(".ad_wh").empty();if(!global_setting.urlList[A]){e.ajax({url:h.api2+"/advert/info.json",dataType:"jsonp",data:{channelId:B.val()},success:function(C){global_setting.urlList[A]=C[A]},error:function(){}})}});z.find(".show_date").datepicker({minDate:new Date(s-86400000*1),maxDate:new Date(s+86400000*90),onClose:function(A,B){if(!(/\d{4}-\d{2}-\d{2}/.test(A))){B.input.val("")}setTimeout(function(){d.verify(B.input.parent())},500)}});z.find(".show_date,.cycle").on("change",function(){var B=z.find(".show_date").val(),A=z.find(".cycle").val();if(B&&A){e.ajax({url:h.api2+"/advert/seller/getputdate.json",type:"get",dataType:"jsonp",data:{ad_sdate:B,cycle:A,locationid:n.locationid},success:function(E){var C=[],D=0;if(E.date_list.length){for(;D<E.date_list.length;D++){C.push("<li>&#xf006a;<span>"+E.date_list[D]+"</span></li>")}x.empty().append(C.join(""))}},error:function(){}})}else{x.empty()}});window.dw=function(B,D){var C=global_setting.urlList[c.pageURL].data[B],A;c.locateKey=B;c.locationid=n.locationid=C.id;z.find(".precision_name").empty().append(C.adName);z.find(".ad_wh").empty().append(C.adWH);A=C.adWH.split("*");n.adWH=C.adWH;z.find(".go_precision .ui_btn_txt").empty().append("重新确定广告位");f.removeCookie("wmad_locateKeyList");f.removeCookie("wmad_asRemarkImgList");b(C.min_date_length,C.max_date_length);if(!D){z.find(".show_date").val("").removeAttr("disabled");x.empty()}k&&k.close(function(){u.css({overflow:"auto"});k=null});return false}};l()});