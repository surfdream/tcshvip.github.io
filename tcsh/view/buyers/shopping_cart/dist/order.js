define(function(require,exports,module){var j=require("domains");var b=require("jquery"),a=require("juicer"),f=require("lib"),c=require("wmbox"),d=require("wmtips"),h=require("wm_ad");var g=function(){var k=b(".main_con"),m=k.find(".comm_item"),l=0;k.find(".express").each(function(){var n=b(this).find(":selected");if(!n.length){n=b(this).find("option:eq(0)")}l+=(n.attr("price")||0)-0});m.each(function(){var n=b(this);l+=(n.attr("pay_money")-0)*(n.attr("pay_count")-0)});k.find(".money_sum").empty().append('商品总价：<b class="pay_money_sum">￥'+l.toFixed(2)+"</b>（含运费）")};var i=function(){g();var k=b(".main_con"),l=k.find("[name='DeliveryId']"),m=b(".da_item.curr");if(m.length){m.find(".set_default").replaceWith('<span class="set_default">默认地址</span>');l.val(m.attr("data_id"))}e();if(global_setting.current.command.DeliveryId){m.removeClass("curr");b(".da_item[data_id='"+global_setting.current.command.DeliveryId+"']").addClass("curr");l.val(global_setting.current.command.DeliveryId)}};var e=function(){var m=b(".main_con"),k=m.find(".da_list"),n=m.find("[name='DeliveryId']");var l=function(p){var o=a(['<div class="da_item" data_id="${id}">','<ul class="da_item_head">',"<li>","<h3>${ProvinceTxt} ${CityTxt}<b>(${consigneeName}&nbsp;收)</b></h3>","</li>","</ul>",'<ul class="da_data">',"<li>","<span>地<i></i>址：</span>","<b>${areaTxt}</b>","</li>","{@if phone}",'<li  class="floatleft pr50">',"<span>联系电话：</span>","<b>${phone}</b>","</li>","{@else if landlineCode}",'<li  class="floatleft pr50">',"<span>联系电话：</span>","<b>${landlineCode}</b>","</li>","{@/if}","<li>","<span>邮<i></i>编：</span>","<b>${chinaZip}</b>","</li>","</ul>",'<div class="btns">','<a href="#" class="set_default">设为默认</a>','<a class="wm_ico fork1 deladitem" href="#" title="删除"></a>','<a class="wm_ico pen1 upaditem" href="#" title="编辑"></a>',"</div>",'<i class="wm_ico hook4 curr_mark"></i>',"</div>"].join(""));o=b(o.render(p||newAddressData));o.data("AddressData",p||newAddressData);return o};m.on("click.addad",".addadbtn",function(){h.show({titleText:"添加收货地址",saveCallBack:function(p){var o;o=l(p);b(".da_list_btns").after(o);o.click();if(p.isDefault){o.find(".set_default").click()}}});return false});m.on("click.upaditem",".upaditem",function(){var s=b(this),p,o=s.closest(".da_item"),r=s.data("upBox");var q=o.data("addressdata");h.show({titleText:"修改收货地址",saveCallBack:function(t){t.id=o.attr("data_id");p=l(t);p.find(".upaditem").data("upBox",s.data("upBox"));o.replaceWith(p);p.click();if(t.isDefault){p.find(".set_default").click()}n.val(t.id)},showCallBack:function(){var t;if(q&&q.id){t=q.areaCode;this.wmBox.find("#selProvince_rent").val(t.substr(0,2)+"0000").change();this.wmBox.find("#selCity_rent").val(t.substr(0,4)+"00").change();this.wmBox.find("#selDistricts_rent").val(t);this.wmBox.find(".textarea_address").val(q.address);this.wmBox.find(".chinazip").val(q.chinaZip);this.wmBox.find(".consignee_name").val(q.consigneeName);t=q.landlineCode.split("-");this.wmBox.find(".landline_code1").val(t[0]);this.wmBox.find(".landline_code2").val(t[1]);this.wmBox.find(".landline_code3").val(t[2]);this.wmBox.find(".phone").val(q.phone);if(q.isDefault){this.wmBox.find("[name='isdefault']").attr("checked","checked")}}}});return false});m.on("click.setAddress",".da_item",function(){var t=b(this),r=[],o="",p,s=[],q;global_setting.current.command.DeliveryId=t.attr("data_id");r=global_setting.current.Id;s=global_setting.current.Bid;for(q in r){r[q]="id="+r[q]}for(q in s){s[q]="bid="+s[q]}o=window.location.href.substr(0,window.location.href.indexOf("?")+1);o+=b.param(global_setting.current.command);if(s){o+=("&"+s.join("&"))}if(r){o+=("&"+r.join("&"))}window.location.href=o;return false});m.on("click.setDefault","a.set_default",function(){var o=b(this);h.ajaxSetDefault({id:o.closest(".da_item").attr("data_id"),success:function(){var p=m.find("span.set_default");p.replaceWith('<a href="#" class="set_default">设为默认</a>');o.replaceWith('<span class="set_default">默认地址</span>')}});return false});m.on("click.deladitem",".deladitem",function(){var r=b(this),o=r.closest(".da_item"),q=o.data("addressdata"),p=m.find(".ad_form");var s=r.data("confirmBox");if(!s){s=c.relyBox({rely:r,boxCls:"confirm_box",content:'<p class="relymsg">你确定要<b style="color:#e13436">删除此收货地址吗？</b><br><span style="color:#999">删除后将无法恢复！</span></p>',btns:[{cls:"ui_btn_h23yellow8",res:"close",text:"确定",callback:function(){h.ajaxDel({id:o.attr("data_id"),success:function(){o.slideUp(300,function(){b(this).remove()});if(o.attr("isupdate")){p.find(".form_sel").val(0);p.find(".form_txt").val("");p.find(":checked").removeAttr("checked");p.find(".form_textarea").val("")}}})}},{cls:"ui_btn_h23yellow8",res:"close",text:"取消",callback:function(){}}]});r.data("confirmBox",s)}s.show();return false});m.on("click.showallad",".showall",function(){m.find(".hideda_list").slideDown(300);b(this).remove();return false});m.on("focus",".remark",function(){var o=b(this);o.css({overflow:"visible"}).animate({height:"100px"},400)});m.on("blur",".remark",function(){var o=b(this);o.scrollTop(0).css({overflow:"hidden"}).animate({height:"18px"},300)});m.on("click",":submit",function(){var p=b(this),o;if(!(global_setting.current.command.DeliveryId-0)){o=p.data("errtips");if(!o){o=new d({ele:p,con:"<p>请选择收货地址！</p>",close:2000,skin:"red2",direction:"tc",offset:{top:-5}});p.data("errtips",o)}o.show();return false}});m.on("change",".express",function(){g()})};i()});