define(function(require,exports,module){var h=require("domains");var d=require("jquery"),c=require("juicer"),e=require("wmbox"),b=require("classbox"),a=require("verification");var g=function(){var i=d(".set_shopping_view");a.addRule([{key:"srtnEmpty",fun:function(){if(!this.closest(".sub_recommend").find(".remove_mask").length){return !!d.trim(this.val()).length}return true}}]);a.init(".set_shopping_view");i.append('<div class="fixed_box" style="left:'+(i.offset().left+i.outerWidth()+10)+'px"><a href="#" class="add_type">+</a></div>');f()};var f=function(){var j=d(".set_shopping_view"),l=j.find(".type_list"),m=j.find(".save_btns");var k=['<li class="form_row type_item">',"<div>",'<label class="row_key">ico：</label>','<input type="text" class="type_ico form_txt" wmv="empty" wmvmsg="ico不能为空！" />',"</div>","<div>",'<label class="row_key">分类名称：</label>','<input type="text" class="type_name form_txt" wmv="empty" wmvmsg="分类名称不能为空！" />','<div class="type_item_btns">','<a href="#" class="iconfont save" title="保存分类">&#xf0131;</a>','<a href="#" class="iconfont show_sub_recommend" title="显示下级推荐">&#xf00e9;</a>','<a href="#" class="iconfont del_type_item" title="删除分类">&#xf00b3;</a>',"</div>","</div>",'<div class="strong_recommend">','<label class="row_key">强推类目：</label>','<p class="contain">暂无强推类目</p>','<a href="#" class="edit_contain">编辑</a>',"</div>",'<div style="clear: both;padding:10px 0 10px 130px;"><a href="#" class="add_sub_recommend">添加下级推荐</a></div>',"</li>"].join("");var i=['<div class="sub_recommend">','<label class="row_key">下级推荐：</label>','<input type="text" class="sr_type_name form_txt" wmv="srtnEmpty" wmvmsg="推荐名称不能为空！" />','<div class="floatleft">','<p class="sub_contain">暂无分类</p>','<div class="sub_contain_btns">','<a href="#" class="edit_sub_contain">编辑</a>','<a href="#" class="del_sub_contain">删除</a>',"</div>","</div>","</div>"].join("");j.on("click",".edit_sub_contain",function(){var o=d(this),n=o.data("thisBox");if(!n){n=b.createBox({callback:function(){var r=this,q=[];var p=o.closest(".sub_recommend");p.attr("no_each","1");j.find(".sub_recommend:not([no_each])").each(function(){var s=d(this);if(!s.find(".remove_mask").length){q.push(s.attr("data_ids"))}});p.removeAttr("no_each");r.disabled(q.join(","));r.chked(p.attr("data_ids"))},submitCallback:function(){var p=o.closest(".sub_recommend"),t=p.closest(".type_item"),s=this.getVal(3).data,v=[],q=[],u=[];for(var r in s){v.push(r);u.push("<span>"+s[r].name+"</span>");q.push(s[r].name)}p.attr("data_ids",v.join(","));p.attr("data_names",q.join(","));p.find(".sub_contain").empty().append(u.join(""))}});o.data("thisBox",n)}n.show();return false});j.on("click",".edit_contain",function(){var o=d(this),n=o.data("thisBox");if(!n){n=b.createBox({callback:function(){var p=o.closest(".strong_recommend"),s=p.data("postdata"),r=[];if(s){for(var q in s){r.push(s[q].id)}this.chked(r)}},submitCallback:function(){var q=o.closest(".strong_recommend"),t=q.find(".contain"),s=this.getVal(3).data,p=[],u=[];for(var r in s){p.push(s[r]);u.push('<a href="http://s.wumeiwang.com/list/'+s[r].id+'.html"  target="_blank">'+s[r].name+"</a>")}q.data("postdata",p);t.empty().append(u.join(""))}});o.data("thisBox",n)}n.show();return false});j.on("click",".add_sub_recommend",function(){var p=d(this),o=p.closest(".type_item"),n;o.find(".show_sub_recommend").click();if(o.find(".sub_recommend").length-o.find(".remove_mask").length<6){n=d(i);if(o.attr("data_id")){n.find(".sub_contain_btns").prepend('<a href="#" class="save_sub_recommend">保存</a>')}p.parent().before(n)}else{alert("最多只能添加6个推荐！")}return false});j.on("click",".save",function(){var n={},q=d(this),p=q.closest(".type_item"),o;if(a.verify(p)){n.ico=p.find(".type_ico").val();n.name=p.find(".type_name").val();n.strong_recommend=p.find(".strong_recommend").data("postdata")||"";o=p.attr("data_id");if(o){n.id=o}n.recommendList=[];n.removeList=[];p.find(".sub_recommend").each(function(){var r=d(this);if(r.find(".remove_mask").length){n.removeList.push({name:r.find(".sr_type_name").val(),id:r.attr("data_id")||"",classIds:r.attr("data_ids")||"",classNames:r.attr("data_names")||""})}else{n.recommendList.push({name:r.find(".sr_type_name").val(),id:r.attr("data_id")||"",classIds:r.attr("data_ids")||"",classNames:r.attr("data_names")||""})}});n.strong_recommend=JSON.stringify(n.strong_recommend);n.recommendList=JSON.stringify(n.recommendList);n.removeList=JSON.stringify(n.removeList);d.ajax({url:h.api2+"/base/defalut/mypicture.json",data:n,type:"post",dataType:"json",success:function(r){if(r.success){alert("保存成功！");p.find(".hide_sub_recommend").click()}else{alert(r.error)}},error:function(){alert("服务器繁忙，请稍后再试！")}})}return false});j.on("click",".save_sub_recommend",function(){var o={},p=d(this),n=p.closest(".sub_recommend");if(a.verify(n)){o.parentId=n.closest(".type_item").attr("data_id");o.id=n.attr("data_id")||"";o.name=n.find(".sr_type_name").val();o.classIds=n.attr("data_ids");o.classNames=n.attr("data_names");d.ajax({url:h.api2+"/base/defalut/recommend.json",data:o,type:"get",dataType:"jsonp",success:function(q){if(q.success){alert("保存成功！");window.location.reload()}else{alert(q.error)}},error:function(){alert("系统繁忙，请稍后再试！")}})}return false});j.on("click",".add_type",function(){l.append(k);return false});j.on("click",".show_sub_recommend",function(){var o=d(this),n=o.closest(".type_item");o.replaceWith('<a href="#" class="iconfont hide_sub_recommend" title="隐藏下级推荐">&#xf00ea;</a>');n.find(".sub_recommend").css({display:"block"});return false});j.on("click",".hide_sub_recommend",function(){var o=d(this),n=o.closest(".type_item");o.replaceWith('<a href="#" class="iconfont show_sub_recommend" title="显示下级推荐">&#xf00e9;</a>');n.find(".sub_recommend").css({display:"none"});return false});j.on("click",".del_sub_contain",function(){var o=d(this),n=o.closest(".sub_recommend");if(n.attr("data_id")){n.append('<div class="remove_mask" style="position: absolute;width: 100%;height: 100%;top: 0;left: 0;background: #000;opacity: 0.7;"><p style="color: #fff;text-align: center;font-size: 20px;line-height:'+n.outerHeight()+'px">保存后彻底删除，<a href="#" class="cancel_remove" style="color: #ff4400;font-size: 14px;font-weight: 700;">取消删除</a></p></div>')}else{n.fadeOut(function(){d(this).remove()})}a.hideTips(n);return false});j.on("click",".del_type_item",function(){var o=d(this),n=o.closest(".type_item");n.find(".hide_sub_recommend").click();if(n.attr("data_id")){n.find(".hide_sub_recommend").click();n.append('<div class="remove_mask" style="position: absolute;width: 100%;height: 100%;top: 0;left: 0;background: #000;opacity: 0.7;"><p style="color: #fff;text-align: center;font-size: 20px;line-height:'+n.outerHeight()+'px">确认删除？<span style="font-size:14px;">删除后无法恢复</span><p style="line-height: 12px;margin-top: -40px;padding-left: 312px;"><a href="#" class="confirm_remove" style="color: #ff4400;font-size: 14px;font-weight: 700;margin-right: 10px;">确认</a><a href="#" class="cancel_remove" style="color: #ff4400;font-size: 14px;font-weight: 700;">取消</a></p></p></div>')}else{n.fadeOut(function(){d(this).remove()})}return false});j.on("click",".cancel_remove",function(){var p=d(this),n=p.closest(".sub_recommend"),o=p.closest(".type_item");if(n.length){if(o.find(".sub_recommend").length-o.find(".remove_mask").length<6){p.closest(".remove_mask").remove()}else{alert("取消后推荐类目将超过6个，请先删除一个再进行取消删除！")}}else{p.closest(".remove_mask").remove()}return false});j.on("click",".confirm_remove",function(){var n=d(this).closest(".type_item");d.ajax({url:h.api2+"/base/defalut/deletemypicture.json",dataType:"jsonp",data:{id:n.attr("data_id")},type:"get",success:function(o){if(o.success){n.fadeOut(function(){n.remove()})}else{alert(o.error)}},error:function(){alert("系统繁忙，请稍后再试！")}});return false})};g()});