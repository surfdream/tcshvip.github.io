define(function(require,exports,module){var h=require("domains");var d=require("jquery"),c=require("juicer"),e=require("wmbox"),b=require("classbox"),a=require("verification");gData={};var g=function(){var i=d(".set_collect");a.init(".set_collect");a.addRule([{key:"tmEmpty",fun:function(){if(!this.closest(".type_item").find(".remove_mask").length){return !!d.trim(this.val()).length}return true}}]);i.append('<div class="fixed_box" style="left:'+(i.offset().left+i.outerWidth()+10)+'px"><a href="#" class="add_type">+</a></div>');f()};var f=function(){var i=d(".set_collect"),k=i.find(".type_list"),l=i.find(".save_btns");var j=['<li class="form_row type_item">',"<div>",'<label class="row_key">分类ico：</label>','<input type="text" class="form_txt type_ico w80"/><span class="iconfont"></span>',"</div>","<div>",'<label class="row_key">分类名称：</label>','<input type="text" class="type_name form_txt" wmv="tmEmpty" wmvmsg="分类名称不能为空！" />',"</div>",'<div class="floatleft">','<p class="contain">暂无分类</p>','<a href="#" class="edit">编辑</a>',"</div>",'<a href="#" class="iconfont remove" title="删除分类">&#xf00b3;</a>',"</li>"].join("");i.on("click",".edit",function(){var n=d(this),m=n.data("thisBox");if(!m){m=b.createBox({ischkNo3:false,callback:function(){var o=n.closest(".type_item"),p=o.siblings(".type_item[data_ids]"),q=[];this.chked(o.attr("data_ids"));if(p.length){p.each(function(){var r=d(this).attr("data_ids");r&&q.push(r)});q=q.join(",");q.split(",");this.disabled(q)}},submitCallback:function(){var q=n.closest(".type_item"),s=this.getVal().data,t=[],o=[],r=[];for(var p in s){t.push(p);r.push("<span>"+s[p].name+"</span>");o.push(s[p].name)}q.attr("data_ids",t.join(","));q.attr("data_names",o.join(","));q.find(".contain").empty().append(r.join(""))}});n.data("thisBox",m)}m.show();return false});i.on("click",".save",function(){var m={};if(a.verify(i)){m.typeList=[];m.removeList=[];i.find(".type_item:not(.save_btns)").each(function(){var n=d(this);if(n.find(".remove_mask").length){m.removeList.push({id:n.attr("data_id")||"",icon:encodeURIComponent(n.find(".type_ico").val()),name:encodeURIComponent(n.find(".type_name").val()),classNames:n.attr("data_names")||"",classIds:n.attr("data_ids")||""})}else{m.typeList.push({id:n.attr("data_id")||"",icon:encodeURIComponent(n.find(".type_ico").val()),name:encodeURIComponent(n.find(".type_name").val()),classNames:n.attr("data_names")||"",classIds:n.attr("data_ids")||""})}});m.typeList=JSON.stringify(m.typeList);m.removeList=JSON.stringify(m.removeList);d.ajax({url:h.api2+"/base/defalut/favorite.json",type:"get",dataType:"jsonp",data:m,success:function(n){if(n.success){alert("保存成功！");window.location.reload()}},error:function(){}})}return false});i.on("click",".add_type",function(){l.before(j);return false});i.on("click",".remove",function(){var n=d(this),m=n.closest(".type_item");if(m.attr("data_id")){n.after('<div class="remove_mask" style="position: absolute;width: 100%;height: 100%;top: 0;left: 0;background: #000;opacity: 0.7;"><p style="color: #fff;text-align: center;font-size: 20px;line-height:'+m.outerHeight()+'px">保存后彻底删除，<a href="#" class="cancel_remove" style="color: #ff4400;font-size: 14px;font-weight: 700;">取消删除</a></p></div>')}else{m.fadeOut(function(){d(this).remove()})}return false});i.on("click",".cancel_remove",function(){d(this).closest(".remove_mask").remove();return false})};g()});