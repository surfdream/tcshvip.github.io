define(function(require,exports,module){var n=require("domains");var f=require("jquery"),m=require("wmupload"),d=require("juicer"),b=require("classbox");require("http://s.tcsh.me/tcsh/view/public/font-face/css/font-face.css#");var g=f("#page"),j;var l=d(["<ul>",'<li class="form_row">','<label class="row_key">真实名称：</label>',"<span>${name}</span>","</li>",'<li class="form_row">','<label class="row_key">昵称：</label>','<input type="text" class="form_txt w150 nickname" value="${nickname}" />',"</li>",'<li class="form_row">','<label class="row_key">背景色：</label>','<input type="text" class="form_txt bg_color_val w80" value="${bgcolor}">','<span class="bg_color" style="background: ${bgcolor}"></span>','<span class="emphasis">背景色必须与小图的四周颜色接近</span>',"</li>",'<li class="form_row">','<label class="row_key">小图：</label>','<div class="floatleft"><img src="${small_img}" class="small_img" style="float:left;max-width:200px"><a href="#" class="iconfont edit_ico">&#xf0022;</a><input type="file" class="form_file up_img" /></div>','<span class="emphasis">小图尺寸建议：宽度140~200，高度160 ~ 280</span>',"</li>",'<li class="form_row">','<label class="row_key">小图链接：</label>','<div class="floatleft"><input type="text" class="form_txt w500 small_img_url" value="${small_img_url}" /></div>',"</li>",'<li class="form_row">','<label class="row_key">优先级：</label>','<input type="text" class="form_txt txt_index w30" value="${sort}"><b class="emphasis"><=0，表示不展示该大类</b>',"</li>",'<li class="form_row">','<label class="row_key">展示类目：</label><a href="#" class="iconfont edit_class">&#xf00c6;</a>','<div class="floatleft sub_class_list" style="width:710px;padding-left: 16px;"></div>',"</li>","</ul>"].join(""));var a=d(["{@each data as item}",'<ul class="sub_class_item" data_id="${item.id}">','<li class="form_row">','<label class="row_key">类目昵称：</label>','<input type="text" class="form_txt sub_class_name" value="${item.name}" />','<a href="#" class="iconfont remove_sub_class_item" title="删除此类">&#xf0155;</a>',"</li>",'<li class="form_row">','<label class="row_key">类目配图：</label>','<img src="${item.big_pic}" class="big_img" style="float:left;width:36px;height:43px"><a href="#" class="iconfont edit_ico">&#xf0022;</a><input type="file" class="form_file up_img" />',"</li>",'<li class="form_row">','<label class="row_key">跳转地址：</label>','<input type="text" class="form_txt sub_class_url" value="${item.classify_url}" />',"</li>","</ul>","{@/each}"].join(""));var i=function(o){f.ajax({url:n.api+"/category",type:"get",dataType:"jsonp",success:function(p){j=p;typeof o==="function"&&o()},error:function(){alert(n.api+"/category  Error !")}})};var e=function(){var q=g.find(".class_list");var o=[];for(var p in j){o.push('<option value="'+p+'">'+j[p].name+"</option>")}q.empty().append('<option value="0">-请选择-</option>');q.append(o.join(""))};var c=function(){f.ajax({url:n.api2+"/base/defalut/street.json",type:"get",dataType:"jsonp",success:function(p){for(var o in p){j[o].nickname=p[o].categoryName;j[o].bgcolor=p[o].bgColor;j[o].small_img=p[o].smallPic;j[o].small_img_url=p[o].url;j[o].sort=p[o].sort;j[o].data=p[o].configureHomeStreet3}typeof callback==="function"&&callback()},error:function(o){throw n.api2+"/base/defalut/street.json Error"}})};var k=function(){var o=f(".set_nav");document.domain="wumeiwang.com";i(function(){e();c()});o.prepend('<li class="btns fixed_box" style="left:'+(o.offset().left+o.outerWidth())+'px"><a href="#" class="ui_btn ui_btn_h33gray15 save"><span class="ui_btn_txt">保存</span></a></li>');h()};var h=function(){var o=g.find(".nav_item");g.find(".class_list").on("change",function(){var r=f(this),q=r.val();if(!(q-0)){o.empty();return}var p=l.render(j[q]);o.empty().append(p);o.find(".sub_class_list").empty().append(a.render(j[q]))});g.on("click",".showhide",function(){var p=f(this);if(p.attr("hide")){p.removeAttr("hide").empty().append("收起");p.closest(".form_row").find(".sub_list .sub_list").css("display","block")}else{p.attr("hide",1).empty().append("展示");p.closest(".form_row").find(".sub_list .sub_list").css("display","none")}return false});g.on("click",".save",function(){var p={},q;p.category_id=g.find(".class_list").val()-0;if(!p.category_id){alert("请选择大类");return false}p.itemlist=[];o.find(".sub_class_item").each(function(){var r=f(this);p.itemlist.push({id:r.attr("data_id"),name:f.trim(r.find(".sub_class_name").val()),big_pic:r.find(".big_img").attr("src"),classify_url:f.trim(r.find(".sub_class_url").val())})});p.category_name=encodeURIComponent(f.trim(o.find(".nickname").val()));p.small_pic=encodeURIComponent(o.find(".small_img").attr("src"));p.product_url=encodeURIComponent(f.trim(o.find(".small_img_url").val()));p.bg_color=f.trim(o.find(".bg_color_val").val());p.sort=f.trim(o.find(".txt_index").val());p.itemlist=JSON.stringify(p.itemlist);f.ajax({url:n.api2+"/base/defalut/savestreet.json",type:"get",dataType:"jsonp",data:p,success:function(r){if(r.success){alert("设置成功！");window.location.reload()}else{alert(r.error||"设置失败！")}},error:function(){alert("保存异常！")}});console.log(p);return false});g.on("keyup",".hover_color",function(){var r=f(this),q=r.closest(".form_row").find(".bg_color"),p=r.val();q.css("background",p)});g.on("change",".up_img",function(){var p=f(this);m.upload(p,function(q){if(q.response){this.closest(".form_row").find("img").attr("src",q.response.imgurl)}})});g.on("click",".edit_class",function(){var q=f(this),p=q.data("thisBox");if(!p){p=b.createBox({ischkNo3:false,callback:function(){var r=[];o.find(".sub_class_item").each(function(){var s=f(this);r.push(s.attr("data_id"))});this.chked(r)},submitCallback:function(){var u=this.getVal();var t=o.find(".sub_class_list"),r;for(var s in u.data){r=t.find(".sub_class_item[data_id='"+s+"']");if(r.length){u.data[s]["name"]=f.trim(r.find(".sub_class_name").val());u.data[s]["big_pic"]=r.find(".big_img").attr("src");u.data[s]["classify_url"]=f.trim(r.find(".sub_class_url").val())}}o.find(".sub_class_list").empty().append(a.render(u))}})}p.show();return false});g.on("click",".remove_sub_class_item",function(){var p=f(this);p.closest(".sub_class_item").remove();return false})};k()});