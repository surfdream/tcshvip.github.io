define(function(require,exports,module){var j=require("domains");var d=require("jquery"),h=require("lib"),e=require("wmbox"),b=require("verification"),c=require("juicer"),a=require("inputdown"),g=require("wmpage");var i=function(){var k=d(".set_tag_box");if(global_setting&&global_setting.PageInfo){var l=g.Create({url:global_setting.PageInfo.url,element:".wm_page",index:global_setting.PageInfo.Index,sum:global_setting.PageInfo.TotalItems,size:global_setting.PageInfo.Size,front:true,param:global_setting.PageInfo.param,pagekey:global_setting.PageInfo.pageKey})}b.strikingSuccess=false;k.append('<div class="fixed_box" style="left:'+(k.offset().left+k.outerWidth()+10)+'px"><a href="#" class="add_group">+</a></div>');f()};var f=function(){var k=d(".set_tag_box");var o=c(['<div class="group_box_main">','<div class="group_box_head">',"<h3>{@if id }修改分组{@else}添加分组{@/if}</h3>",'<a href="#" class="iconfont close">&#xf00b3;</a>',"</div>",'<div class="group_box_con">','<ul class="wm_form" data_id="${id}">','<li class="form_row">','<label class="row_key"><b class="form_must">*</b>分组名称：</label>','<input type="text" class="form_txt w300 group_name" wmv="empty" wmvmsg="分组名称不能为空！" name="group_name_${m}" value="${name}" />','<span class="group_name_error" for="group_name_${m}"></span>',"</li>",'<li class="form_row btns">','<label class="row_key">&nbsp;</label>','<a href="#" class="ui_btn ui_btn_h33gray15 submit"><span class="ui_btn_txt">确定</span></a>','<a href="#" class="ui_btn ui_btn_h33gray15 close"><span class="ui_btn_txt">取消</span></a>',"</li>","</ul>","</div>","</div>"].join(""));var m=c(["{@each success as item}",'<div class="tag_item" data_id="${item.tagId}"><a target="_blank" href="http://s.wumeiwang.com/search?q=${item.tagName}">${item.tagName}</a><a href="#" class="wm_ico fork2  remove_tag"></a></div>',"{@/each}",].join(""));var l=function(q){var p=parseInt(Math.random()*99999)+9999;return e.invBox({boxCls:"group_box",content:o.render(d.extend({m:p},q)),callback:function(){var r=this,s=this.wmBox.find(".wm_form");this.close=this.hide;this.wmBox.on("click",".submit",function(){var u=d(this),t=s.attr("data_id");if(b.verify(s)){if(t){d.ajax({url:j.api2+"/sns/modifytagclass.json",data:{id:t,className:encodeURIComponent(d.trim(s.find(".group_name").val()))},type:"get",dataType:"jsonp",success:function(v){if(v.success){alert("修改成功！");window.location.reload()}else{alert(v.error||"修改失败！")}},error:function(){alert("系统繁忙！")}})}else{d.ajax({url:j.api2+"/sns/addtagclass.json",data:{className:encodeURIComponent(d.trim(s.find(".group_name").val()))},type:"get",dataType:"jsonp",success:function(v){if(v.success){alert("添加成功！");window.location.reload()}else{alert(v.error||"添加失败！")}},error:function(){alert("系统繁忙！")}})}}return false})}})};var n=function(q,p){d.ajax({url:j.api2+"/sns/selecttag.json",type:"get",data:{id:q},dataType:"jsonp",success:function(r){if(r.success){p.empty().append(m.render(r))}}})};k.on("click",".add_group",function(){var q=d(this),p=q.data("groupBox");if(!p){p=l();q.data("groupBox",p)}p.wmBox.find(".group_name").val("");p.show();return false});k.on("click",".edit_group",function(){var t=d(this),s=t.closest("tr"),r=s.attr("data_id"),p=s.attr("data_name"),q=t.data("groupBox");if(!q){q=l({id:r,name:p});t.data("groupBox",q)}q.show();return false});k.on("click",".del_group",function(){var q=d(this),p=q.closest("tr");if(confirm("确定删除该分组？删除后无法恢复")){d.ajax({url:j.api2+"/sns/deletetagclass.json",data:{id:p.attr("data_id")},type:"get",dataType:"jsonp",success:function(r){if(r.success){p.fadeOut(function(){p.remove()})}else{alert(r.error||"删除失败！")}},error:function(){alert("系统繁忙！")}})}return false});k.on("click",".remove_tag",function(){var p=d(this),q=p.closest(".tag_item");d.ajax({url:j.api2+"/sns/deletetag.json",data:{id:q.attr("data_id")},type:"get",dataType:"jsonp",success:function(r){if(r.success){q.fadeOut(function(){q.remove()})}else{alert(r.error||"删除失败！")}},error:function(){alert("系统繁忙！")}});return false});k.on("click",".add_tag",function(){var s=d(this),t=s.data("addTagBox"),r=s.closest("tr"),p=r.find(".tag_list"),q=r.attr("data_id");if(!t){t=e.invBox({boxCls:"gat_box",content:['<div class="gat_main">','<div class="gat_head">',"<h3>添加标签</h3>",'<a href="#" class="iconfont close">&#xf00b3;</a></div>','<div class="gat_con">','<ul class="wm_form" data_id="">','<li class="form_row">','<label class="row_key"><b class="form_must">*</b>标签名称：</label><input type="text" class="form_txt w300 tag_name"><a href="#" class="ui_btn ui_btn_h26white6 confirm_add_tag"><span class="ui_btn_txt">添加</span></a>','<input type="hidden" class="tag_id" />',"</li>",'<li class="form_row">','<label class="row_key">已有：</label><div class="floatleft new_tag_list"></div>',"</li>","</ul>","</div>","</div>"].join(""),callback:function(){var v=this,x=this.wmBox.find(".wm_form"),u,y=this.wmBox.find(".new_tag_list"),w=this.wmBox.find(".tag_name");this.close=function(){v.hide();u.hideDownList()};this.wmBox.on("click",".submit",function(){var z=d(this);if(b.verify(x)){v.close()}return false});setTimeout(function(){u=a.Create({input:v.wmBox.find(".tag_name"),position:"fixed",zIndex:v.wmBox.css("z-index"),listItemModel:["<ul>","{@each success as item}",'<li class="input_downitem" data_text="${item.tagName}">',"<span>${item.tagName}</span>","</li>","{@/each}","</ul>"].join(""),updownCallback:function(z){this.val(z.attr("data_text"))},callback:function(){var z=this;this.$input.on("focus",function(){if(d(this).val()){z.showDownList()}});this.$input.on("blur",function(){setTimeout(function(){z.hideDownList()},100)});this.$input.on("keydown",function(){var A=d(this);A.attr("old_val",A.val())});this.$input.on("keyup",function(){var B=d(this),A=B.attr("old_val"),C=B.val();if(A!=C){d.ajax({url:j.api2+"/sns/findtag.json",type:"get",dataType:"jsonp",data:{tagName:encodeURIComponent(C)},success:function(D){if(D.success){z.empty().append(D,function(){z.showDownList()})}},error:function(){}})}});this.$downBox.on("click",".input_downitem",function(){var A=d(this);z.$input.val(A.attr("data_text"));z.hideDownList();return false})}})},500);this.wmBox.on("click",".confirm_add_tag",function(){var A=d.trim(w.val()),z;if(A){d.ajax({url:j.api2+"/sns/addtag.json",type:"get",dataType:"jsonp",data:{tagName:encodeURIComponent(A),classid:q},success:function(C){var B;if(C.success){B=y.find(".tag_item[data_id='"+C.success.tagId+"']");if(B.length){h.BGShine({ele:B,original_color:"#d1ebfe",change_color:"#09c",frequency:3,callback:function(){B.removeAttr("style")}})}else{z='<div class="tag_item" data_id="'+C.success.tagId+'"><a target="_blank" href="http://s.wumeiwang.com/search?q='+A+'">'+A+'</a><a href="#" class="wm_ico fork2  remove_tag"></a></div>';y.prepend(z);p.prepend(z);w.val("")}}else{alert(C.error||"添加失败！")}},error:function(){alert("系统繁忙！")}})}else{h.BGShine({ele:w,original_color:"#fff",change_color:"#ff6363",frequency:3})}return false})}});s.data("addTagBox",t)}n(q,t.wmBox.find(".new_tag_list"));t.show();return false})};i()});