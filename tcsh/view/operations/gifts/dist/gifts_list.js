define(function(require,exports,module){var i=require("domains");var c=require("jquery"),b=require("juicer"),g=require("lib"),a=require("verification"),f=require("wmpage"),d=require("wmbox");var h=function(){a.addRule([{key:"sel_empty",fun:function(){return !!(this.val()-0===1)}}]);if(global_setting&&global_setting.PageInfo){var j=f.Create({url:global_setting.PageInfo.url+"?"+c(".user_list_search").serialize(),element:".wm_page",index:global_setting.PageInfo.Index,sum:global_setting.PageInfo.TotalItems,size:global_setting.PageInfo.Size,front:true,param:global_setting.PageInfo.param,pagekey:global_setting.PageInfo.pageKey,across:true})}e()};var e=function(){var j=c("#page");var k=b(['<div class="gifts_box_head">',"<h3>{@if id}编辑{@else}添加{@/if}-礼物</h3>",'<a href="#" class="iconfont close">&#xf00b3;</a>',"</div>",'<div class="gifts_box_main">','<form action="'+i.operator+'/present/{@if id}edit{@else}add{@/if}">','<div class="wm_form">',"<ul>",'<li class="form_row">','<label class="row_key"><b class="form_must">*</b>礼物标题：</label>','<input type="text" class="form_txt" name="title" value="${name}" wmv="empty" wmvmsg="礼物标题不能为空！" />',"</li>",'<li class="form_row">','<label class="row_key"><b class="form_must">*</b>礼物类型：</label>','<select class="form_sel gifts_type" wmv="sel_empty" wmvmsg="暂时只能添加商品！">','<option value="0">-请选择-</option>','<option value="1">商品</option>','<option value="2">代金卷</option>',"</select>","</li>",'<li class="form_row gifts_type_main"></li>','<li class="form_row getway_list">','<label class="row_key"><b class="form_must">*</b>获取途径：</label>','<div class="floatleft">','<input type="checkbox" name="${m}" id="${m}_reg" value="1" /><label class="chk_key" for="${m}_reg">注册</label>',"</div>","</li>",'<li class="form_row">','<label class="row_key">QQ：</label>','<input type="text" class="form_txt" name="sellerqq" value="${qq}" />',"</li>",'<li class="form_row">','<label class="row_key">备注：</label>','<textarea class="form_textarea w500" name="remark" value="${remark}">${remark}</textarea>',"</li>","</ul>","</div>",'<div class="btns">','<a href="#" class="close">取消</a><input type="submit" class="submit" value="确定">','<input type="hidden" name="id" value="${id}" />',"</div>","</form>","</div>"].join(""));var n={"1":b(["<fieldset>","<legend>商品</legend>",'<p style="border: 1px solid #ffcc7f;background-color: #ffffe5;width: 90%;margin: 10px auto;padding-left: 10px;">礼物商品库存数据将不受正常销售影响！</p>',"<ul>",'<li class="form_row">','<label class="row_key"><b class="form_must">*</b>商品ID：</label>','<input type="text" class="form_txt w50 cid" name="productid" value="${product_id}" />',"</li>",'<li class="form_row">','<label class="row_key">商家ID：</label><span class="cuid">${seller_id}</span>',"</li>",'<li class="form_row">','<label class="row_key">商家名称：</label><span class="cuname">${seller_name}</span>',"</li>",'<li class="form_row">','<label class="row_key">商品名称：</label><a href="'+i.item+'/${product_id}.html" class="floatleft w410 cname" target="_blank">${product_name}</a>',"</li>",'<li class="form_row">','<label class="row_key"><b class="form_must">*</b>礼品数量：</label>','<input type="text" class="form_txt w50 csum" name="presentcount" value="${sum}" wmv="positiveInteger" wmvmsg="请填写正确的数量！" />',"</li>",'<li class="form_row">','<label class="row_key">推广商品：</label>','<div class="floatleft" style="width: 100%">','<ul class="promotion_list">',"{@each promotion as item}",'<li class="promotion_item">','<input type="text" class="form_txt w50 promotion_id" placeholder="商品Id" value="${item}" /><a href="#" target="_blank" class="comm_link"></a>','<a href="#" class="iconfont remove_item">&#xf0155;</a>',"</li>","{@/each}","</ul>",'<a href="#" class="add_promotion">添加推广商品</a>','<input type="hidden" class="promotion_data" name="promotion" />',"</div>","</li>","</ul>","</fieldset>"].join("")),"2":b(["<fieldset>","<legend>代金券</legend>","<ul>",'<li class="form_row">','<p style="border: 1px solid #ffcc7f;background-color: #ffffe5;width: 90%;margin: 10px auto;padding-left: 10px;">代金券系统正在开发</p>',"</li>","</ul>","</fieldset>"].join(""))};var l=function(){this.find(".cid").val("");this.find(".cuid").empty();this.find(".cuname").empty();this.find(".cname").attr("href","").empty()};var m=function(o){return d.invBox({boxCls:"gifts_box",content:k.render(c.extend({m:"chk_m_"+parseInt(Math.random()*9999)},o)),callback:function(){var p=this;var q=this.wmBox.find(".promotion_list");this.close=function(){a.hideTips(p.wmBox);p.hide()};this.wmBox.find(".gifts_type").on("change",function(){var t=c(this),s=t.val();p.wmBox.find(".gifts_type_main").empty().append(n[s].render(o&&o.gifts_data));p.position();a.hideTips(p.wmBox)});this.wmBox.on("change",".cid",function(){var s=c(this).val(),t=p.wmBox.find(".csum").val();if(s){c.ajax({url:"http://operator.tcsh.me/asyn/product/product_with_sellerinfo.json",dataType:"jsonp",data:{product_id:s},success:function(u){if(u.response.data){p.wmBox.find(".gifts_type_main").find(".cid").val(u.response.data.product_id);p.wmBox.find(".gifts_type_main").find(".cuid").empty().append(u.response.data.seller_id);p.wmBox.find(".gifts_type_main").find(".cuname").empty().append(u.response.data.seller_name);p.wmBox.find(".gifts_type_main").find(".cname").attr("href",i.item+"/"+u.response.data.product_id+".html").empty().append("product_name")}else{alert(u.response.error.message||"服务器繁忙");l.call(p.wmBox.find(".gifts_type_main"))}},error:function(){alert("服务器繁忙");l.call(p.wmBox.find(".gifts_type_main"))}})}else{l.call(p.wmBox.find(".gifts_type_main"))}});this.wmBox.on("change",".promotion_id",function(){var u=c(this),t=u.val(),s=u.closest(".promotion_item");if(t){c.ajax({url:"http://operator.tcsh.me/asyn/product/product_with_sellerinfo.json",dataType:"jsonp",data:{product_id:t},success:function(v){if(v.response.data){s.find(".comm_link").attr("href",i.item+"/"+v.response.data.product_id+".html").empty().append(v.response.data.seller_name);s.data("promotion_item",{product_id:v.response.data.product_id,seller_name:v.response.data.seller_name})}else{alert("无效的商品ID");u.val("");s.data("promotion_item",0)}},error:function(){u.val("");alert("服务器繁忙");s.data("promotion_item",0)}})}else{s.find(".comm_link").attr("href","").empty();s.data("promotion_item",0)}});this.wmBox.on("click",".submit",function(){if(a.verify(p.wmBox)){var s=[];p.wmBox.find(".promotion_item").each(function(){var t=c(this).data("promotion_item");t&&s.push(t.product_id)});p.wmBox.find(".promotion_data").val(JSON.stringify(s));return true}return false});this.wmBox.on("click",".add_promotion",function(){if(!q.length){q=p.wmBox.find(".promotion_list")}q.append(['<li class="promotion_item">','<input type="text" class="form_txt w50 promotion_id" placeholder="商品Id" /><a href="#" target="_blank" class="comm_link"></a>','<a href="#" class="iconfont remove_item">&#xf0155;</a>',"</li>"].join(""));return false});this.wmBox.on("click",".remove_item",function(){var s=c(this).closest(".promotion_item");s.fadeOut(function(){s.remove()});return false});if(o){this.wmBox.find(".gifts_type").val(o.type).change();this.wmBox.find(".cid").change();for(var r in o.getway){this.wmBox.find(".getway_list [value='"+o.getway[r]+"']").attr("checked","checked")}this.wmBox.find(".promotion_item").length&&this.wmBox.find(".promotion_id").change()}a.minZIndex=p.wmBox.css("z-index")}})};j.on("click",".add_gifts",function(){var p=c(this),o=p.data("gifts_box");if(!o){o=m();p.data("gifts_box",o)}o.show();return false});j.on("click",".edit_gifts",function(){var q=c(this),p=q.closest("tr"),o=q.data("gifts_box");if(!o){o=m({id:p.attr("data_id"),name:p.attr("data_name"),type:p.attr("data_type"),gifts_data:{product_id:p.attr("data_product_id"),sum:p.attr("data_present_count"),promotion:p.data("promotion")},getway:p.attr("data_getway").split(","),remark:p.attr("data_remark"),qq:p.attr("data_qq")});q.data("gifts_box",o)}o.show();return false});j.on("click",".down_gifts",function(){c.ajax({url:"",dataType:"json",data:{},success:function(){},error:function(){alert("系统繁忙！")}});return false});j.on("click",".up_gifts",function(){c.ajax({url:"",dataType:"json",data:{},success:function(){},error:function(){alert("系统繁忙！")}});return false})};h()});