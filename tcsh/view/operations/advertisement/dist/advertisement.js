define(function(require,exports,module){var h=require("domains");var c=require("jquery"),b=require("juicer"),g=require("wmupload"),a=require("verification");var e=function(l,i){var j=c("#page");var k=i.split("*");l.find(".default_img").css({width:k[0],height:k[1]})};var f=function(){var i=c("#page");a.addRule([{key:"dataComplete",fun:function(){var l=this.find(".ad").val(),k=this.find(".ad_url").val(),j=this.find(".default_img").attr("src");return !!(l&&k&&j)}}]);i.find(".sub_ad_item").each(function(){var j=c(this);e(j,global_setting.urlList[global_setting.url].data[j.find(".go_precision").attr("attr_locate_key")].adWH)});d();i.find(".min_length").each(function(){var m=c(this),l=m.closest(".sub_ad_item"),k=m.val()-0,j=k-l.find(".sub_location_item").length;if(j){l.append('<span class="iconfont" style="position: absolute;top: 10px;right: 10px;color: #b30004;font-size: 30px;cursor: pointer;" title="默认设置不全">&#xf0142;</span>');m.change()}})};var d=function(){var i=c("#page"),j=i.find(".min_length");i.on("click",".go_precision",function(){var l=c(this),k=l.attr("attr_locate_key");l.attr("href",global_setting.url+"?"+c.param({locateKey:k,asRemarkImg:global_setting.urlList[global_setting.url].data[k].asRemarkImg}))});i.on("click",".show_all",function(){i.find(".sub_location_item").addClass("sub_location_item_hover");return false});j.on("focus",function(){var k=c(this);k.attr("old_val",k.val())});j.on("change",function(){var r=c(this),q=r.closest(".sub_ad_item"),p=q.find(".sub_location_list"),o=r.val(),k,n=o-0-q.find(".sub_location_item:visible").length,m,l;if(n>=0){k=[];while(n--){l=q.find(".display_none:first");if(l.length){l.removeClass("display_none").css({display:"block"})}else{k.push('<li class="sub_location_item sub_location_item_hover" wmv="dataComplete" wmvmsg="广告位默认数据不完整！"><ul><li class="form_row"><label class="row_key">广告词：</label><input type="text" class="form_txt ad" /></li><li class="form_row hide"><label class="row_key">URL：</label><input type="text" class="form_txt ad_url" /></li><li class="form_row hide"><label class="row_key">图片：</label><div class="floatleft"><input type="file" class="up_img" /><img class="default_img" src="" /></div></li></ul></li>')}}k.push('<li class="btns"><a href="#" class="show_all">全部展示</a></li>');p.append(k.join(""))}else{n=Math.abs(n);while(n--){q.find(".sub_location_item:not(.display_none):last:visible").addClass("display_none").css({display:"none"})}}e(q,global_setting.urlList[global_setting.url].data[q.attr("data_locate_key")].adWH)});i.on("change",".up_img",function(){g.upload(c(this),function(k){this.closest(".form_row").find(".default_img").attr("src",k.response.imgurl)})});i.on("click",".del_sub_location_item",function(){var k=c(this);k.closest(".sub_location_item").slideUp(function(){$max_length.val($max_length.val()-0-1);c(this).remove()});return false});i.on("click",":submit",function(){var m=c(this),l=m.closest(".sub_ad_item"),k={};if(!a.verify(l)){return false}k.id=global_setting.urlList[global_setting.url].data[l.attr("data_locate_key")].id;k.asName=encodeURIComponent(l.find(".as_name").val());k.asRemark=encodeURIComponent(l.find(".as_remark").val());k.min_length=l.find(".min_length").val();k.max_length=l.find(".max_length").val();k.min_date_length=l.find(".min_date_length").val();k.max_date_length=l.find(".max_date_length").val();k.unitMoney=l.find(".unitMoney").val();k.defaultList=[];l.find(".sub_location_item:visible").each(function(){var n=c(this);k.defaultList.push({id:n.attr("data_id"),adTitle:n.find(".ad").val(),adUrl:n.find(".ad_url").val(),adPic:n.find(".default_img").attr("src")})});k.removeIds=[];l.find(".sub_location_item:hidden").each(function(){var n=c(this).attr("data_id");if(n){k.removeIds.push(n)}});k.removeIds=k.removeIds.join(",");k.defaultList=JSON.stringify(k.defaultList);c.ajax({url:h.api2+"/adlocation/api/location.json",type:"get",dataType:"jsonp",data:k,success:function(n){if(n.success){alert("保存成功！");window.location.href=window.location.href}else{n.error&&alert(n.error)}},error:function(){alert("系统繁忙！")}});return false});i.find(".update").toggle(function(){var k=c(this);k.attr("title","隐藏信息").empty().append("&#xf00ea;");k.closest(".sub_ad_item").css({height:"initial"});a.hideTips();return false},function(){var k=c(this);k.attr("title","查看完整信息").empty().append("&#xf00e9;");k.closest(".sub_ad_item").css({height:"40px"});a.hideTips();return false})};f()});