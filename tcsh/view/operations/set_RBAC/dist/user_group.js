define(function(require,exports,module){var i=require("domains");var c=require("jquery"),g=require("lib"),d=require("wmbox"),a=require("verification"),b=require("juicer"),e=require("api");var h=function(){a.strikingSuccess=false;f()};var f=function(){var k=c(".user_group");var n=b(['<div class="ids_main">','<div class="ids_head">',"<h3>{@if id }修改分组{@else}添加分组{@/if}</h3>",'<a href="#" class="iconfont close">&#xf00b3;</a>',"</div>",'<div class="ids_con">','<ul class="wm_form" data_id="${id}">','<li class="form_row">','<label class="row_key"><b class="form_must">*</b>分组名称：</label>','<input type="text" class="form_txt group_name" wmv="empty" wmvmsg="分组名称不能为空！" name="group_name_${m}" value="${group_name}" />','<span for="group_name_${m}"></span>',"</li>",'<li class="form_row">','<label class="row_key">分组描述</label>','<input type="text" class="form_txt remark" value="${remark}" />',"</li>",'<li class="form_row">','<label class="row_key">&nbsp;</label>','<a href="#" class="ui_btn ui_btn_h33gray15 submit"><span class="ui_btn_txt">确定</span></a>','<a href="#" class="ui_btn ui_btn_h33gray15 close"><span class="ui_btn_txt">取消</span></a>',"</li>","</ul>","</div>","</div>"].join(""));var j=b(['<div class="ids_main">','<div class="ids_head">',"<h3>${groupName}-分配角色</h3>",'<a href="#" class="iconfont close">&#xf00b3;</a>',"</div>",'<div class="ids_con">','<div class="role_list_box">','<ul class="box_head">','<li class="w50">选择</li>','<li class="w100">角色</li>',"<li>角色说明</li>","</ul>",'<div class="role_list" data_group_id="${groupId}"></div>','<div class="btns">','<a href="#" class="ui_btn ui_btn_h33gray15 submit"><span class="ui_btn_txt">确定</span></a>','<a href="#" class="ui_btn ui_btn_h33gray15 close"><span class="ui_btn_txt">取消</span></a>',"</div>","</div>","</div>","</div>"].join(""));var m=b(["{@each success as item}",'<ul data_id="${item.id}" class="role_row">','<li class="w50"><span class="chkbox iconfont">&#xf00b2;</span></li>','<li class="w100">${item.name}</li>',"<li>${item.remark}</li>","</ul>","{@/each}",].join(""));var l=function(o){return d.invBox({boxCls:"inv_default_skin",content:n.render(c.extend({m:parseInt(Math.random()*99999)+9999},o)),callback:function(){var p=this,r=this.wmBox.find(".wm_form"),q=r.attr("data_id");this.close=this.hide;a.init(r);this.wmBox.on("click",".submit",function(){var t=r.find(".group_name").val(),s=r.find(".remark").val();if(a.verify(r)){if(q){e.editGroup({group_id:q,group_name:t,group_remark:s,success:function(u){if(u.success){alert("修改成功");window.location.reload()}else{alert(u.error||"修改失败！")}},error:function(){alert("系统繁忙！")}})}else{e.addGroup({group_name:t,group_remark:s,success:function(u){if(u.success){alert("添加成功");window.location.reload()}else{alert(u.error||"添加失败！")}},error:function(){alert("系统繁忙！")}})}}return false})}})};k.on("click",".add_user_group",function(){var p=c(this),o=p.data("groupBox");if(!o){o=l();p.data("groupBox",o)}o.show();return false});k.on("click",".edit_user_group",function(){var t=c(this),r=t.data("groupBox"),s=t.closest("tr"),q=s.attr("data_id"),o=s.attr("data_name"),p=s.attr("data_remark");if(!r){r=l({id:q,group_name:o,remark:p});t.data("groupBox",r)}r.show();return false});k.on("click",".del_group",function(){var p=c(this),o=p.closest("tr");if(confirm("确定要删除角色？删除后无法恢复")){e.delGroup({id:o.attr("data_id"),success:function(q){if(q.success){alert("删除成功！");window.location.reload()}else{alert(q.error)}},error:function(){alert("服务器繁忙！")}})}return false});k.on("click",".set_role",function(){var r=c(this),q=r.closest("tr"),p=q.attr("data_id"),s=q.attr("data_name"),o=r.data("group_set_role");if(!o){o=d.invBox({boxCls:"inv_default_skin group_set_role",content:j.render({groupId:p,groupName:s}),callback:function(){var t=this;var u=this.wmBox.find(".role_list");this.close=this.hide;this.wmBox.on("click",".submit",function(){var v=t.wmBox.find(".role_list"),w=[];v.find(".curr").each(function(){w.push(c(this).attr("data_id"))});e.roleToGroup({groupId:v.attr("data_group_id"),roleIds:JSON.stringify(w),success:function(x){if(x.success){window.location.reload()}else{alert(x.error||"分配失败！")}},error:function(){alert("系统繁忙！")}});return false});this.wmBox.on("click",".role_row",function(){c(this).toggleClass("curr");return false});e.getRoleList({success:function(v){if(v.success){u.empty().append(m.render(v));t.position()}},error:function(){alert("系统繁忙！")}})}});r.data("group_set_role",o)}o.show();return false})};h()});