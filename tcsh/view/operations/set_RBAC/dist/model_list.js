define(function(require,exports,module){var h=require("domains");var c=require("jquery"),f=require("lib"),g=require("wmbox"),b=require("verification"),k=require("juicer"),e=require("chk_model_page"),l=require("api");var a={};var j=function(v,u,t,s){var q,p;if(u&&u.length){for(var r in u){if(u[r].subList&&u[r].subList.length){q=c("<dd><dl></dl></dd>"),p=q.find("dl");p.append('<dt><a href="#" class="iconfont show_sub_btn">&#xf0175;</a><a href="#'+u[r].id+'" class="set_node" data_id="'+u[r].id+'" data_name="'+u[r].name+'" data_parent_id="'+t+'" data_parent_name="'+s+'">'+u[r].name+"</a></dt>");p.append(j(p,u[r].subList,u[r].id,u[r].title))}else{q='<dd><a href="#'+u[r].id+'" class="set_node" data_id="'+u[r].id+'" data_name="'+u[r].name+'" data_parent_id="'+t+'" data_parent_name="'+s+'">'+u[r].name+"</a></dd>"}v.append(q)}}};var i=k(["{@each sub_model_list as item}",'<tr data_id="${item.id}" data_name="${item.name}" data_remark="${item.remark}">',"<td>${item.name}</td>","<td>${item.remark}</td>","<td>",'<div class="btn_list">','<a href="http://y.wumeiwang.com/sys!selectmodel.action?sysModuleClass.name=${item.name}&sysModuleClass.id=${item.id}" class="ui_btn ui_btn_h23yellow8 portal"><span class="ui_btn_txt">页面设置<span class="wm_ico arrow6down"></span></span></a>',"<ul>",'<li class="btn_list_last">','<a href="http://y.wumeiwang.com/sys!selectmodel.action?sysModuleClass.name=${item.name}&sysModuleClass.id=${item.id}" class="">页面设置</a>',"</li>","<li>",'<a href="#" class="edit_model">修改</a>',"</li>",'<li class="btn_list_end">','<a href="#" class="del_model">删除</a>',"</li>","</ul>","</div>","</td>","</tr>","{@/each}"].join(""));var d=function(q){var p=c(".model_list tbody");p.empty().append(i.render(q))};var n=function(){l.getModelTree({success:function(t){var s=window.window.location.hash;var r;if(t.success){var q=c(".nav_tree");var p=c('<dl><dt><a href="#" class="iconfont f5_tree">&#xf015c;</a><a href="#" class="set_node" data_id="'+t.success.id+'" data_name="'+t.success.name+'">'+t.success.name+"</a></dt></dl>");j(p,t.success.subList,t.success.id,t.success.name);q.empty().append(p);r=q.find("[href='"+s+"']");if(s.length>1&&r.length){q.find(".show_sub_btn").click();r.click()}else{c(".set_node:eq(0)").click()}}},error:function(){alert("模块树初始化失败，请稍后再试！")}})};var m=function(){b.strikingSuccess=false;b.addRule([{key:"default_model",fun:function(){return !!(this.find(".page_id").val()&&this.find(".default_url").val())}}]);o();n()};var o=function(){var p=c(".nav_list"),s=p.find(".set_nav_tree");var r=k(['<div class="model_box_main">','<div class="model_box_head">',"<h3>{@if id }修改模块{@else}添加模块{@/if}</h3>",'<a href="#" class="iconfont close">&#xf00b3;</a>',"</div>",'<div class="model_box_con">','<ul class="wm_form" data_id="${id}">','<li class="form_row">','<label class="row_key"><b class="form_must">*</b>模块名称：</label>','<input type="text" class="form_txt model_name" wmv="empty" wmvmsg="模块名称不能为空！" name="model_name_${m}" value="${model_name}"/>','<span class="model_name_error" for="model_name_${m}"></span>',"</li>",'<li class="form_row">','<label class="row_key">备注：</label>','<input type="text" class="form_txt model_remark" value="${remark}" />',"</li>",'<li class="form_row btns">','<label class="row_key">&nbsp;</label>','<a href="#" class="ui_btn ui_btn_h33gray15 submit"><span class="ui_btn_txt">确定</span></a>','<a href="#" class="ui_btn ui_btn_h33gray15 close"><span class="ui_btn_txt">取消</span></a>',"</li>","</ul>","</div>","</div>"].join(""));var q=function(u){return g.invBox({boxCls:"model_box",content:r.render(c.extend({m:parseInt(Math.random()*99999)+9999},u)),callback:function(){var v=this,w=this.wmBox.find(".wm_form");this.close=this.hide;b.init(w);this.wmBox.find(".remark").on("focus",function(){c(this).addClass("complete");return false});this.wmBox.find(".remark").on("blur",function(){var x=c(this);setTimeout(function(){x.removeClass("complete");x.scrollTop(0)},500);return false});this.wmBox.on("click",".submit",function(){var x=w.attr("data_id");if(b.verify(w)){if(w.attr("data_id")){l.editModel({id:x,name:encodeURIComponent(c.trim(w.find(".model_name").val())),remark:encodeURIComponent(c.trim(w.find(".model_remark").val())),success:function(y){if(y.success){p.find(".f5_tree").click();p.find(".set_node.curr").click();w.find(".model_name").val("");w.find(".model_remark").val("")}else{alert(y.error||"编辑失败！")}},error:function(){alert("系统繁忙！")}})}else{l.addModel({parent_id:a.nodeId,name:encodeURIComponent(c.trim(w.find(".model_name").val())),remark:encodeURIComponent(c.trim(w.find(".model_remark").val())),success:function(y){if(y.success){p.find(".f5_tree").click();p.find(".set_node.curr").click();w.find(".model_name").val("");w.find(".model_remark").val("")}else{alert(y.error||"添加失败！")}},error:function(){alert("系统繁忙！")}})}v.close()}return false});t.call(this.wmBox.find(".chk_model_page"))}})};var t=function(){this.on("click",function(){var w=c(this),v=w.data("cmpBox"),u=w.closest(".form_row");if(!v){v=e.create({ispage:true,callback:function(){var x=this;this.pageChk.on("change",function(){var y=c(this);if(y.attr("checked")){x.pageChk.removeAttr("checked");y.attr("checked","checked")}});this.chkPage(u.find(".page_id").val())},submitCallback:function(y){u.find(".page_name").val("");u.find(".page_id").val("");u.find(".default_url").val("");for(var x in y.pageList){u.find(".page_name").val(y.pageList[x].name);u.find(".page_id").val(y.pageList[x].id);u.find(".default_url").val(y.pageList[x].url)}}});w.data("cmpBox",v)}v.show();return false})};p.on("click",".show_sub_btn",function(){var v=c(this),u=v.closest("dd");u.addClass("show_sub_dd");v.attr("class","iconfont hide_sub_btn").empty().append("&#xf0176;");return false});p.on("click",".hide_sub_btn",function(){var v=c(this),u=v.closest("dd");u.removeClass("show_sub_dd");v.attr("class","iconfont show_sub_btn").empty().append("&#xf0175;");return false});p.on("click",".set_node",function(){var w=c(this);var v=w.attr("data_id"),x=w.attr("data_parent_id"),u=w.attr("data_parent_name");p.find(".curr").removeClass("curr");w.addClass("curr");s.find("h3").empty().append(w.html()+"模块配置");l.getModelDetail({id:v,success:function(y){if(y.success){a.nodeId=y.success.id;a.nodeName=y.success.name;a.remark=y.success.remark;a.parentId=x;a.parentName=u;w.attr("data_name",y.success.name).empty().append(y.success.name);d(y.success);p.find(".node_remark").empty().append('<i class="wm_ico bulb1"></i>'+y.success.remark)}},error:function(){var y={id:v,name:w.html(),remark:"",sub_model_list:[{id:"123123",name:"名称",remark:""},{id:"123123",name:"名称",remark:""},{id:"123123",name:"名称",remark:""},{id:"123123",name:"名称",remark:""},{id:"123123",name:"名称",remark:""}]}}})});p.on("click",".add_sub_model",function(){var v=c(this),u=v.data("treeNodeBox");if(!u){u=q({parent_id:a.nodeId,parent_name:a.nodeName});v.data("treeNodeBox",u)}u.wmBox.find(".parent_name").empty().append(a.nodeName);u.show();return false});p.on("click",".node_btns .edit_model",function(){var v=c(this),u=v.data("treeNodeBox");if(!u){u=q({id:a.nodeId,model_name:a.nodeName,remark:a.remark});v.data("treeNodeBox",u)}u.wmBox.find(".model_name").val(a.nodeName);u.wmBox.find(".model_remark").val(a.remark);u.show();return false});p.on("click",".model_list .edit_model",function(){var z=c(this),w=z.data("treeNodeBox");var y=z.closest("tr");var x=y.attr("data_id"),u=y.attr("data_name"),v=y.attr("data_remark");if(!w){w=q({id:x,model_name:u,remark:v});z.data("treeNodeBox",w)}w.show();return false});p.on("click",".del_model",function(){var v=c(this),u=v.closest("tr");if(confirm("确定要删除该模块？删除后无法恢复")){l.delModel({id:u.length?u.attr("data_id"):p.find(".set_node.curr").attr("data_id"),success:function(w){if(w.success){p.find(".f5_tree").click();p.find(".set_node.curr").click()}else{alert(w.error||"删除失败！")}},error:function(){alert("系统繁忙！")}})}return false});p.on("click",".f5_tree",function(){n();return false})};m()});