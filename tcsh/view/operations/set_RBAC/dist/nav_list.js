define(function(require,exports,module){var l=require("domains");var d=require("jquery"),i=require("lib"),f=require("wmbox"),a=require("verification"),c=require("juicer"),e=require("chk_model_page");var j={};var g=function(s,r,q,p){var n,m;if(r&&r.length){for(var o in r){if(r[o].subList&&r[o].subList.length){n=d("<dd><dl></dl></dd>"),m=n.find("dl");m.append('<dt><a href="#" class="iconfont show_sub_btn">&#xf0175;</a><a href="#" class="set_node" data_id="'+r[o].id+'" data_name="'+r[o].title+'" data_parent_id="'+q+'" data_parent_name="'+p+'">'+r[o].title+"</a></dt>");m.append(g(m,r[o].subList,r[o].id,r[o].title))}else{n='<dd><a href="#" class="set_node" data_id="'+r[o].id+'" data_name="'+r[o].title+'" data_parent_id="'+q+'" data_parent_name="'+p+'">'+r[o].title+"</a></dd>"}s.append(n)}}};var b=function(){d.ajax({url:"",data:{},dataType:"json",type:"get",success:function(){},error:function(){var n={id:"1",title:"根目录",subList:[{id:"1",title:"测试1",subList:[{id:"1",title:"测试1.1",subList:[{id:"1",title:"测试1.1.1",subList:[{id:"1",title:"测试1.1.1.1",subList:[{id:"1",title:"测试1.1.1",subList:[{id:"1",title:"测试1.1.1.1.1",subList:[{id:"1",title:"测试1.1.1.1.1.1",subList:[{id:"1",title:"测试1.1.1.1.1.1.1",subList:[]}]}]}]}]}]},{id:"1",title:"测试1.1.2",subList:[{id:"1",title:"测试1.1.2.1",subList:[]}]}]},{id:"1",title:"测试1.2",subList:[{id:"1",title:"测试1.2.1",subList:[{id:"1",title:"测试1.2.1.1",subList:[]}]},{id:"1",title:"测试1.2.2",subList:[{id:"1",title:"测试1.2.2.1",subList:[]}]}]}]},{id:"1",title:"公告管理",subList:[{id:"1",title:"公告列表",subList:[]}]},{id:"1",title:"广告管理",subList:[{id:"1",title:"广告位设置",subList:[]},{id:"1",title:"广告审核",subList:[]},{id:"1",title:"已审核广告",subList:[]}]},{id:"1",title:"审核管理",subList:[{id:"1",title:"商家审核",subList:[]},{id:"1",title:"限时购审核",subList:[]},{id:"1",title:"新品预售审核",subList:[]},{id:"1",title:"美推手审核",subList:[]},{id:"1",title:"新品试用审核",subList:[]},{id:"1",title:"免费送审核",subList:[]},{id:"1",title:"兑换审核",subList:[]}]},{id:"1",title:"分类设置",subList:[{id:"1",title:"收藏分类设置",subList:[]},{id:"1",title:"用户喜好分类设置",subList:[]}]},{id:"1",title:"积分设置",subList:[{id:"1",title:"积分获取方案设置",subList:[]},{id:"1",title:"积分获取方案审核",subList:[]}]},{id:"1",title:"RBAC",subList:[{id:"1",title:"用户组列表",subList:[]},{id:"1",title:"权限组列表",subList:[]},{id:"1",title:"模块列表",subList:[]},{id:"1",title:"导航树设置",subList:[]}]},{id:"1",title:"标签",subList:[{id:"1",title:"传统标签维护",subList:[]},{id:"1",title:"消费者标签",subList:[]},{id:"1",title:"商家标签",subList:[]},{id:"1",title:"采集标签",subList:[]},{id:"1",title:"全站标签",subList:[]}]},{id:"1",title:"统计",subList:[{id:"1",title:"浏览器使用",subList:[]},{id:"1",title:"访问时间",subList:[]}]},{id:"1",title:"SEO",subList:[{id:"1",title:"基础SEO设置",subList:[]},{id:"1",title:"商品分类SEO设置",subList:[]}]},{id:"1",title:"聊天设置",subList:[{id:"1",title:"聊天头部图片设置",subList:[]}]},{id:"1",title:"全局设置",subList:[{id:"1",title:"扣点设置",subList:[]}]},]};var m=d('<dl><dt><a href="#" class="iconfont f5_tree">&#xf015c;</a><a href="#" class="set_node" data_id="'+n.id+'" data_name="'+n.title+'">根目录</a></dt></dl>');g(m,n.subList,n.id,n.title);d(".nav_tree").empty().append(m);d(".set_node:eq(0)").click()}})};var k=function(){a.strikingSuccess=false;a.addRule([{key:"default_model",fun:function(){return !!(this.find(".page_id").val()&&this.find(".default_url").val())}}]);h();b()};var h=function(){var m=d(".nav_list"),p=m.find(".set_nav_tree");var o=c(['<div class="ids_main">','<div class="ids_head">',"<h3>{@if id }修改节点{@else}添加节点{@/if}</h3>",'<a href="#" class="iconfont close">&#xf00b3;</a>',"</div>",'<div class="ids_con">','<ul class="wm_form" data_id="${id}">','<li class="form_row">','<label class="row_key">父级节点：</label>','<span class="parent_name">${parent_name}</span>','<input type="hidden" class="parent_id" value="${parent_id}">',"</li>",'<li class="form_row">','<label class="row_key"><b class="form_must">*</b>节点名称：</label>','<input type="text" class="form_txt node_name" wmv="empty" wmvmsg="节点名称不能为空！" name="node_name_${m}" value="${node_name}" />','<span for="node_name_${m}"></span>',"</li>",'<li class="form_row">','<label class="row_key"><b class="form_must">*</b>默认模块页面：</label>','<div class="floatleft" wmv="default_model" wmvmsg="请选择默认模块页面！" name="default_model_${m}">','<input type="text" class="form_txt page_name"  value="${page_name}" readonly="readonly"><a href="#" class="ui_btn ui_btn_h22red21 chk_model_page"><span class="ui_btn_txt">选择</span></a>','<input type="hidden" class="page_id" value="${page_id}">','<input type="hidden" class="default_url" value="${default_url}">','<input type="hidden" class="model_id" value="${model_id}">',"</div>",'<span for="default_model_${m}"></span>',"</li>",'<li class="form_row">','<label class="row_key">节点备注</label>','<textarea class="form_textarea remark" value="${remark}"></textarea>',"</li>",'<li class="form_row btns">','<label class="row_key">&nbsp;</label>','<a href="#" class="ui_btn ui_btn_h33gray15 submit"><span class="ui_btn_txt">确定</span></a>','<a href="#" class="ui_btn ui_btn_h33gray15 close"><span class="ui_btn_txt">取消</span></a>',"</li>","</ul>","</div>","</div>"].join(""));var n=function(r){return f.invBox({boxCls:"inv_default_skin tree_node_box",content:o.render(d.extend({m:parseInt(Math.random()*99999)+9999},r)),callback:function(){var s=this,t=this.wmBox.find(".wm_form");this.close=this.hide;a.init(t);this.wmBox.find(".remark").on("focus",function(){d(this).addClass("complete");return false});this.wmBox.find(".remark").on("blur",function(){var u=d(this);setTimeout(function(){u.removeClass("complete");u.scrollTop(0)},500);return false});this.wmBox.on("click",".submit",function(){if(a.verify(t)){s.close()}return false});q.call(this.wmBox.find(".chk_model_page"))}})};var q=function(){this.on("click",function(){var t=d(this),s=t.data("cmpBox"),r=t.closest(".form_row");if(!s){s=e.create({ispage:true,callback:function(){var u=this;this.pageChk.on("change",function(){var v=d(this);if(v.attr("checked")){u.pageChk.removeAttr("checked");v.attr("checked","checked")}});this.chkPage(r.find(".page_id").val())},submitCallback:function(u){r.find(".page_name").val("");r.find(".page_id").val("");r.find(".default_url").val("");r.find(".model_id").val("");r.find(".page_name").val(u.name);r.find(".page_id").val(u.id);r.find(".default_url").val(u.url);r.find(".model_id").val(u.model_id);a.verify(r)}});t.data("cmpBox",s)}s.show();return false})};m.on("click",".show_sub_btn",function(){var s=d(this),r=s.closest("dd");r.addClass("show_sub_dd");s.attr("class","iconfont hide_sub_btn").empty().append("&#xf0176;");return false});m.on("click",".hide_sub_btn",function(){var s=d(this),r=s.closest("dd");r.removeClass("show_sub_dd");s.attr("class","iconfont show_sub_btn").empty().append("&#xf0175;");return false});m.on("click",".set_node",function(){var r=d(this);m.find(".curr").removeClass("curr");r.addClass("curr");p.find("h3").empty().append(r.html()+"节点配置");j.nodeId=r.attr("data_id");j.nodeName=r.attr("data_name");j.parentId=r.attr("data_parent_id");j.parentName=r.attr("data_parent_name");return false});m.on("click",".add_sub_node",function(){var s=d(this),r=s.data("treeNodeBox");if(!r){r=n({parent_id:j.nodeId,parent_name:j.nodeName});s.data("treeNodeBox",r)}r.wmBox.find(".parent_name").empty().append(j.nodeName);r.show()});m.on("click",".edit_node_name",function(){var s=d(this),r=s.data("treeNodeBox");if(!r){r=n({parent_id:j.parentId,parent_name:j.parentName,node_name:j.nodeName,id:j.nodeId});s.data("treeNodeBox",r)}r.wmBox.find(".parent_name").empty().append(j.parentName);r.wmBox.find(".node_name").val(j.nodeName);r.wmBox.find(".page_name").empty().append("页面名称");r.wmBox.find(".page_id").empty().append("123");r.wmBox.find(".default_url").empty().append(l.account+"/login?ReturnUrl=http%3a%2f%2fitem.wumeiwang.com%2flogisticstemplate");r.show()});q.call(m.find(".chk_model_page"));m.on("click",".page_name",function(){m.find(".chk_model_page").click();return false});m.on("click",".del_node",function(){if(confirm("确定要删除该节点？删除后无法恢复")){}return false});m.on("click",".f5_tree",function(){b();return false})};k()});