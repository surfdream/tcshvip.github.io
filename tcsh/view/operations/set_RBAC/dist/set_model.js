define(function(require,exports,module){var k=require("domains");var c=require("jquery"),h=require("lib"),d=require("wmbox"),b=require("juicer"),a=require("verification"),i=require("chk_model"),g=require("wmpage"),e=require("api");var j=function(){var l=c(".set_page_box");l.append('<div class="fixed_box" style="left:'+(l.offset().left+l.outerWidth()+10)+'px"><a href="#" class="add_page">+</a></div>');a.strikingSuccess=false;if(global_setting&&global_setting.PageInfo){var m=g.Create({url:global_setting.PageInfo.url,element:".wm_page",index:global_setting.PageInfo.Index,sum:global_setting.PageInfo.TotalItems,size:global_setting.PageInfo.Size,front:true,param:global_setting.PageInfo.param,pagekey:global_setting.PageInfo.pageKey})}f()};var f=function(){var t=c(".set_page_box"),p=c(".search"),m=p.find(".search_model_name"),l=p.find("#search_model_id");var r=b(['<div class="page_box_main">','<div class="page_box_head">',"<h3>{@if id }修改页面{@else}添加页面{@/if}</h3>",'<a href="#" class="iconfont close">&#xf00b3;</a>',"</div>",'<div class="page_box_con">','<ul class="wm_form" data_id="${id}">','<li class="form_row">','<label class="row_key"><b class="form_must">*</b>模块名称：</label>','<input type="text" class="form_txt page_model" wmv="empty" wmvmsg="请选择模块！" style="width: 230px;" name="page_model_${m}" value="${model_name}" readonly="readonly" />','<a href="#" class="ui_btn ui_btn_h22red21 chk_model"><span class="ui_btn_txt">选择</span></a>','<span class="page_name_error" for="page_model_${m}"></span>','<input type="hidden" class="page_model_id" value="${model_id}" />',"</li>",'<li class="form_row">','<label class="row_key"><b class="form_must">*</b>页面名称：</label>','<input type="text" class="form_txt page_name" wmv="empty" wmvmsg="页面名称不能为空！" name="page_name_${m}" value="${name}" />','<span class="page_name_error" for="page_name_${m}"></span>',"</li>",'<li class="form_row">','<label class="row_key"><b class="form_must">*</b>页面URL：</label>','<input type="text" class="form_txt page_url" wmv="empty" wmvmsg="页面URL不能为空！" name="page_url_${m}" value="${url}" />','<span class="page_url_error" for="page_url_${m}"></span>',"</li>",'<li class="form_row btns">','<label class="row_key">&nbsp;</label>','<a href="#" class="ui_btn ui_btn_h33gray15 submit"><span class="ui_btn_txt">确定</span></a>','<a href="#" class="ui_btn ui_btn_h33gray15 close"><span class="ui_btn_txt">取消</span></a>',"</li>","</ul>","</div>","</div>"].join(""));var s=b(['<div class="competence_box_main">','<div class="competence_box_head">',"<h3>${name} - 权限维护</h3>",'<a href="#" class="iconfont close">&#xf00b3;</a>',"</div>",'<div class="competence_box_con">','<ul class="wm_form" data_id="${id}">','<li class="form_row"><label class="row_key"><b class="form_must">*</b>权限名称：</label><input type="text" class="form_txt add_name"></li>','<li class="form_row"><label class="row_key">备注：</label><input type="text" class="form_txt w300 add_remark"></li>','<li class="form_row"><label class="row_key">&nbsp;</label><a href="#" class="ui_btn ui_btn_h22white7 add_competence"><span class="ui_btn_txt">添加</span></a></li>','<li class="" style="margin-top:10px">','<table cellpadding="0" cellspacing="0" class="table_list competence_list">',"<thead>","<tr>",'<th style="width:70px">权限Code</th>','<th style="width:100px">权限名称</th>',"<th>备注</th>",'<th style="width: 70px;text-align: left; padding-left: 15px;">操作</th>',"</tr>","</thead>","</table>","</li>",'<li class="competence_list_box">','<table cellpadding="0" cellspacing="0" class="table_list competence_list">',"<tbody>","</tbody>","</table>","</li>","</ul>","</div>","</div>"].join(""));var q=b(["{@each success as item}",'<tr data_id="${item.id}" data_name="${item.name}" data_remark="${item.remark}">','<td style="width:70px">${item.code}</td>','<td><input type="text" class="form_txt edit_text c_name" value="${item.name}" readonly="readonly" /></td>','<td><input type="text" class="form_txt edit_text c_remark" value="${item.remark}" readonly="readonly" /></td>',"<td>",'<div class="btn_list ">','<a href="#" class=" portal del_competence"><span class="ui_btn_txt">删除<span class="wm_ico arrow8down"></span></span></a>',"<ul>",'<li class="btn_list_last">','<a href="#" class="del_competence">删除</a>',"</li>",'<li class="btn_list_end">','<a href="#" class="edit_competence">修改</a>',"</li>","</ul>","</div>",'<div class="btn_list edit_btns">','<a href="#" class="ui_btn ui_btn_h23yellow8 portal save"><span class="ui_btn_txt">保存<span class="wm_ico arrow6down"></span></span></a>',"<ul>",'<li class="btn_list_last">','<a href="#" class="save">保存</a>',"</li>",'<li class="btn_list_end">','<a href="#" class="close_change">取消</a>',"</li>","</ul>","</div>","</td>","</tr>","{@/each}"].join(""));var n=function(v,u){e.getPageCompetenceList({id:v,success:function(w){u.wmBox.find(".competence_list_box tbody").empty().append(q.render(w));u.position()},error:function(){throw"api.getPageCompetenceList Error！"}})};var o=function(u){return d.invBox({boxCls:"page_box",content:r.render(c.extend({m:parseInt(Math.random()*99999)+9999},u)),callback:function(){var v=this,x=this.wmBox.find(".wm_form"),w=x.find(".page_model"),y=x.find(".page_model_id");this.close=this.hide;a.init(x);this.wmBox.on("click",".submit",function(){var D=c(this),B=x.attr("data_id"),C=x.find(".page_model_id").val(),z=encodeURIComponent(c.trim(x.find(".page_name").val())),A=encodeURIComponent(c.trim(x.find(".page_url").val()));if(a.verify(x)){if(B){e.editPage({id:B,modelId:C,name:z,url:A,success:function(E){if(E.success){window.location.reload()}else{alert(E.error||"修改失败！")}},error:function(){alert("系统繁忙！")}})}else{e.addPage({modelId:C,name:z,url:A,success:function(E){if(E.success){window.location.reload()}else{alert(E.error||"添加失败！")}},error:function(){alert("系统繁忙！")}})}v.close()}return false});this.wmBox.on("click",".chk_model",function(){var z=c(this),A=z.data("chkBox");if(!A){A=i.create({callback:function(){this.chk(y.val())},submitCallback:function(B){w.val(B.name);y.val(B.id);a.verify(z.closest(".form_row"))}});z.data("chkBox",A)}A.show();return false});this.wmBox.on("click",".page_model",function(){v.wmBox.find(".chk_model").click();return false})}})};t.on("click",".add_page",function(){var u=c(this),v=u.data("add_page");if(!v){v=o();u.data("add_page",v)}v.show();return false});t.on("click",".edit_page",function(){var z=c(this),y=z.closest("tr"),x=z.data("edit_page"),u=y.attr("data_name"),w=y.attr("data_url"),v=y.attr("data_id");if(!x){x=o({id:v,name:u,url:w,model_name:u,model_id:v});z.data("edit_page",x)}x.show();return false});t.on("click",".del_page",function(){var v=c(this),u=v.closest("tr");if(confirm("确定删除该模块？删除后无法恢复")){e.delPage({id:u.attr("data_id"),success:function(w){if(w.success){u.fadeOut(function(){u.remove()})}else{alert(w.error||"删除失败！")}},error:function(){alert("系统繁忙！")}})}return false});t.on("click",".set_competence",function(){var y=c(this),x=y.closest("tr"),u=x.attr("data_name"),w=x.attr("data_id"),v=x.data("competence_box");if(!v){v=d.invBox({boxCls:"competence_box",content:s.render({id:w,name:u}),callback:function(){var z=this;this.close=this.hide;this.wmBox.on("click",".edit_competence",function(){var B=c(this),A=B.closest("tr");if(!A.hasClass("edit")){A.addClass("edit");A.find(".edit_text").removeAttr("readonly")}return false});this.wmBox.on("click",".close_change",function(){var B=c(this),A=B.closest("tr");A.removeClass("edit");A.find(".edit_text").attr("readonly","readonly");A.find(".c_name").val(A.attr("data_name"));A.find(".c_remark").val(A.attr("data_remark"));return false});this.wmBox.on("click",".save",function(){var E=c(this),D=E.closest("tr"),C=D.attr("data_id"),A=c.trim(D.find(".c_name").val()),B=c.trim(D.find(".c_remark").val());if(A){e.pageEditCompetence({id:C,name:encodeURIComponent(A),remark:encodeURIComponent(B),success:function(F){if(F.success){D.removeClass("edit");D.find(".edit_text").attr("readonly","readonly")}else{alert(F.error||"修改失败！")}},error:function(){alert("系统繁忙！")}})}else{h.BGShine({ele:D.find(".c_name"),original_color:"#fff",change_color:"#ff6363",frequency:3})}return false});this.wmBox.on("click",".del_competence",function(){var B=c(this),A=B.closest("tr"),C=A.closest(".wm_form");if(confirm("确定删除该权限？删除后将无法恢复")){e.pageDelCompetence({moduelid:C.attr("data_id"),id:A.attr("data_id"),success:function(D){if(D.success){A.fadeOut(function(){A.remove()})}else{alert(D.error||"删除失败！")}},error:function(){alert("系统繁忙！")}})}return false});this.wmBox.on("click",".add_competence",function(){var D=z.wmBox.find(".add_name"),B=z.wmBox.find(".add_remark"),A=c.trim(D.val()),C=c.trim(B.val());if(A){D.val("");B.val("");e.pageAddCompetence({pageId:w,name:encodeURIComponent(A),remark:encodeURIComponent(C),success:function(E){if(E.success){z.wmBox.find(".competence_list_box tbody").prepend(q.render({success:[{id:E.success.id,code:E.success.code,name:A,remark:C}]}))}else{alert(E.error||"添加失败！")}},error:function(){alert("系统繁忙！")}})}else{h.BGShine({ele:D,original_color:"#fff",change_color:"#ff6363",frequency:3})}return false})}});x.data("competence_box",v)}n(w,v);v.show();return false});p.on("click",".chk_model",function(){var u=c(this),v=u.data("chkBox");if(!v){v=i.create({callback:function(){this.chk(l.val())},submitCallback:function(w){m.val(w.name);l.val(w.id)}});u.data("chkBox",v)}v.show();return false});m.on("click",function(){p.find(".chk_model").click();return false})};j()});