define(function(require,exports,module){var h=require("domains");var c=require("jquery"),b=require("juicer"),g=require("wmupload"),a=require("wmverification"),d=require("wmbox");var f=function(){var i=c(".wm_form");a.addRule([{key:"imgEmpty",fun:function(){if(!this.closest(".form_row_img").find(".del_mask").length){return(this.find("img").attr("src")||"").length>0}else{return true}}}]);a.init(i);e()};var e=function(){var k=c("#page"),j=k.find(".wm_form"),m=j.find(".chat_con");var i=['<ul class="chat_con">','<li class="form_row">',"<label>名称：</label>",'<input type="text" id="chat_kind" class="form_txt" wmv="empty" wmvmsg="名称不能为空！" />',"</li>",'<li class="form_row_add">','<a href="#" class="add_new_img">添加图片</a>',"</li>",'<li class="iconfont chat_btn">','<a href="#" class="chat_save">&#xf0131;</a>','<a href="#" class="chat_show" title="显示图片">&#xf00e9;</a>','<a href="#" class="chat_del">&#xf00b3;</a>',"</li>","</ul>"].join("");var l=['<div class="form_row_img">','<a href="#" class="chat_img" wmv="imgEmpty" wmvmsg="请上传图片！">+<span>图片比例为<em>970*150</em></span><img src="" class="upload_img" /></a>','<input type="file" class="form_file" title="点击上传"  />','<input type="hidden" class="file_url">','<span class="img_operate">','<a href="#" class="del_img">删除</a>',"</span>","</div>"].join("");k.on("change",".form_row_img .form_file",function(){var n=c(this);g.upload(n,function(o){var p=this.closest(".form_row_img");if(o.response){p.find("img").show().attr("src",o.response.imgurl).css("display","block");p.find(".file_url").val(o.response.imgurl)}})});k.on("click",".add_img",function(){var n=c(i);k.find(".chat_item").append(n);return false});j.on("click",".add_new_img",function(){var p=c(this),n=p.closest(".form_row_add"),o=c(l),q=p.closest(".chat_con");q.find(".chat_show").click();p.before(o);o.find(".form_file").on("change",function(){var r=c(this);g.upload(r,function(s){var t=this.closest(".form_row_img");if(s.response){t.find("img").show().attr("src",s.response.imgurl).css("display","block");t.find(".file_url").val(s.response.imgurl)}})});return false});j.on("click",".chat_del",function(){var n=c(this),p=n.closest(".chat_con");a.hideTips(p);p.find(".chat_hide").click();if(p.attr("data_id")){var o='<div class="del_mask"><ul><li>确认删除？，<span>删除后无法恢复！</span></li><li><span class="del_mask_btn"><a href="#" class="sure_del">确定</a><a href="#" class="cancel_del">取消</a></span></li></ul></div>';p.append(o)}else{p.fadeOut()}return false});j.on("click",".sure_del",function(){var o=c(this),p=o.closest(".chat_con"),n={};n.id=p.attr("data_id");c.ajax({url:h.api2+"/sns/deletemessagesceneimg.json",type:"get",data:n,dataType:"jsonp",success:function(q){if(q.success){alert("删除成功！");window.location.reload()}else{alert(q.error)}},error:function(){alert("系统繁忙，稍后再试！")}});return false});j.on("click",".cancel_del",function(){var n=c(this);n.closest(".del_mask").remove();return false});j.on("click",".chat_save",function(){var p=c(this),q=p.closest(".chat_con"),o=q.find(".form_row_img"),n={};if(a.verify(q)){n.id=q.attr("data_id")||"";n.theme=q.find(".form_txt").val();n.jsonimg=[];o.each(function(){var r=c(this);if(!r.find(".del_mask").length){n.jsonimg.push(r.find(".upload_img").attr("src"))}});n.jsonimg=JSON.stringify(n.jsonimg);c.ajax({url:h.api2+"/sns/messagesceneimg.json",type:"get",dataType:"jsonp",data:n,success:function(r){if(r.success){alert("保存成功！");window.location.reload()}else{alert(r.error)}},error:function(){alert("系统繁忙，稍后再试！")}})}return false});j.on("click",".chat_show",function(){var n=c(this),o=n.closest(".chat_con");n.replaceWith('<a href="#" class="chat_hide" title="隐藏添加的图片">&#xf00ea;</a>');o.find(".form_row_img").css({display:"block"});return false});j.on("click",".chat_hide",function(){var n=c(this),o=n.closest(".chat_con");n.replaceWith('<a href="#" class="chat_show" title="显示添加的图片">&#xf00e9;</a>');o.find(".form_row_img").css({display:"none"});return false});j.on("click",".save_img",function(){var o=c(this),n=o.closest(".form_row_img");img=[],$upload_img=n.find(".upload_img");if(a.verify(n)){img.push({imgid:$upload_img.attr("data_id")||"",imgsrc:$upload_img.attr("src")})}return false});j.on("click",".del_img",function(){var o=c(this),n=o.closest(".form_row_img");a.hideTips(n);if(n.find(".upload_img").attr("data_id")){var p='<div class="del_mask" style="line-height:'+n.outerHeight()+'px;">保存后彻底删除，<a href="#" class="cancel_del">撤销删除</a></div>';n.append(p)}else{n.remove()}return false})};f()});