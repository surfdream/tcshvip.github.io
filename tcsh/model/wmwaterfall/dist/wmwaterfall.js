define(function(require,exports,module){var b=require("http://s.tcsh.me/tcsh/model/lib/jquery/seajs-jquery-1.8.3.min.js");var a=function(g){var k=this;var c=b.extend({listEle:".waterfall_list",itemEle:".waterfall_item",spacing:20},g);var d=0,h;var j,f=0,l=0;var i=function(m,o){var n=m.find("img").length;d=0;if(n===0){typeof o==="function"&&o();return}m.find("img").on("error",function(){b(this).attr("src","http://s.tcsh.me/tcsh/view/public/img/img404_1.png")});if(navigator.appName=="Microsoft Internet Explorer"){m.find("img").each(function(){var p=new Image();p.onreadystatechange=function(){if(p.readyState=="complete"){d++;d===n&&typeof o==="function"&&o()}};p.src=b(this).attr("src")})}else{m.find("img").load(function(){d++;d===n&&typeof o==="function"&&o()})}};var e=function(o,p){var q=p||false,m,n=0;o.css({position:"absolute"});o.each(function(t){var v=b(this),s=v.outerWidth(),u=v.outerHeight(),r=Number.MAX_VALUE;if(q){k.$List.find("[bott]").each(function(){var w=b(this);r=Math.min(r,w.attr("bott")-0)});m=k.$List.find("[bott='"+r+"']:eq(0)").removeAttr("bott");f=r;l=m.attr("left")-0}else{f=0;l=v.index()*(s+k.Spacing);q=l+s*2+k.Spacing*2>=j}v.css({top:f,left:l}).attr("bott",f+u+k.Spacing).attr("left",l).attr("top",f);l+=s+k.Spacing});k.$List.find("[bott]").each(function(){var r=b(this);n=Math.max(n,r.attr("bott")-0)});k.$List.height(n)};this.$List=b(c.listEle);this.$Item=b(c.itemEle);this.Spacing=c.spacing;this.reset=function(){k.$List=b(c.listEle);k.$Item=b(c.itemEle);j=k.$List.width(),f=0,l=0;k.$Item.css({top:0,left:0}).removeAttr("left").removeAttr("bott");e(k.$Item)};this.append=function(o,p){if(!(o instanceof b)){o=b(o)}var n=k.$List.find("[bott]");k.$List.append(o);k.$Item=b(c.itemEle);if(!n.length){i(o,function(){k.reset();typeof p==="function"&&p.call(k.$List)})}else{var m=-1;i(o,function(){l=0;n.each(function(){m=Math.max(m,parseFloat(b(this).attr("top")));l=Math.max(l,parseFloat(b(this).attr("left")))});e(o,m>0);typeof p==="function"&&p.call(k.$List)})}};this.getMaxBott=function(){var m=0;k.$List.find("[bott]").each(function(){m=Math.max(m,parseFloat(b(this).attr("bott")))});return m};this.stuff=function(){var m=k.$Item.last().clone().empty();var n=k.getMaxBott();m.css({top:0,left:0}).removeAttr("bott").removeAttr("left").removeAttr("top").addClass("waterallstuff");k.$List.find("[bott]").each(function(){var o=m.clone();if(b(this).attr("bott")!=n){k.append(o,function(){o.removeAttr("bott");o.css({display:"block",height:n-(o.attr("top")-0)-k.Spacing})})}})};k.$List.css({position:"relative"});k.reset()};exports.create=function(c){return new a(c)}});