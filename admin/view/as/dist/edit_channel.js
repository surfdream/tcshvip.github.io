define(function(require,exports,module){var f=require("domains");var a=require("jquery"),c=require("lib"),e=require("wmupload");var d=function(){var g=a(".channel_form ");window.document.domain="tcsh.me";g.find("ul:eq(0)").prepend('<li class="btns fixed_box" style="left:'+(g.offset().left+g.outerWidth())+'px"><a href="#" class="add" title="添加广告位">+</a></li>');g.find(".upimg:not([src=''])").css({display:"block"});b();g.find(".aswh").change()};var b=function(){var h=a("#page"),i=h.find(".channel_form_main");var g=['<li class="form_row location_item">','<label class="row_key"><b>广告位</b></label>',"<ul>",'<li class="form_row">','<label class="row_key ">广告位位置：</label><a href="#" class="ui_btn ui_btn_h27gray8 go_locate" target="_blank"><span class="ui_btn_txt">定位</span></a><span></span></li>','<li class="form_row">','<label class="row_key">广告类型：</label>','<select class="form_sel as_type">','<option value="1" selected="selected">商品</option>','<option value="2">店铺</option>','<option value="3">活动</option>',"</select>","</li>",'<li class="form_row">','<label class="row_key">是否限制类别：</label>','<select class="form_sel is_limit">','<option value="1">是</option>','<option value="0" selected="selected">否</option>',"</select>","</li>",'<li class="form_row">','<label class="row_key ">广告位名称：</label><input type="text" class="form_txt w550 as_name" /></li>','<li class="form_row">','<label class="row_key ">广告展示类型描述：</label>','<input type="text" class="form_txt as_remark" />',"</li>",'<li class="form_row">','<label class="row_key ">广告尺寸：</label>','<input type="text" class="form_txt aswh" /><span>格式：width*height</span>',"</li>",'<li class="form_row">','<label class="row_key ">配图：</label>','<input type="file" class="with_map" />','<img class="upimg" />',"</li>","</ul>","</li>"];h.on("click",".go_locate",function(){var l=a(this),j="lk_"+parseInt(Math.random()*9999999)+1000;l.attr("locate_key",j);var k=a.trim(a(".locate_url").val());if(!k){alert("目标地址，不能为空！");return false}l.attr("href",k+"?"+a.param({is_as_locate:"t",lk:j}))});h.on("change",".with_map",function(){e.upload(a(this),function(j){var k=this;k.closest(".form_row").find("img").attr("src",j.response.imgurl).css("display","block")})});h.on("change",".aswh",function(){var l=a(this),k=a.trim(l.val()).split("*"),j=l.closest(".location_item").find(".upimg");j.css({width:k[0],height:k[1]})});h.on("click",".add",function(){i.append(g.join(""));return false});h.on("click",".save",function(){var k={},l=[],j=[];k.adchannelid=c.queryString("id");k.channelName=encodeURIComponent(i.find(".channel_name").val());k.channelURL=i.find(".locate_url").val();k.asList=[];i.find(".location_item").each(function(){var o=a(this),n=o.attr("data_pagekey"),m;if(n){m=o.find(".upimg");l.push(n);j.push(m.attr("src"));k.asList.push({id:o.attr("data_id"),adChannelId:o.attr("data_id"),adLocation:n,adType:o.find(".as_type").val(),adLimit:o.find(".is_limit").val(),adLocationName:encodeURIComponent(o.find(".as_name").val()),describe:encodeURIComponent(o.find(".as_remark").val()),adSize:encodeURIComponent(o.find(".aswh").val()),figure:m.attr("src")})}});k.data=JSON.stringify(l.join(",")+"|"+encodeURIComponent(j.join(",")));k.asList=JSON.stringify(k.asList);a.ajax({url:f.api2+"/adlocation/api/channel.json",type:"get",dataType:"jsonp",data:k,success:function(m){if(m.success){alert("设置成功！");window.location.href=f.j+"/adlocation/modifyadlocation?id="+m.id}else{m.error&&alert(m.error)}},error:function(){alert("设置异常！")}});return false});h.find(".locate_url").on("change",function(){var k=a(this),j=k.val();if(j[j.length-1]==="/"){k.val(j.substr(0,j.length-1));k.change()}});window.dw=function(j,l){var k=h.find(".go_locate[locate_key='"+l+"']");k.next("span").empty().append("页面标记："+j);k.closest(".location_item").attr("data_pagekey",j)}};d()});